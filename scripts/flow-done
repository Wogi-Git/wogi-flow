#!/bin/bash

# Wogi Flow - Complete Task

set -e

WORKFLOW_DIR=".workflow"
READY_JSON="$WORKFLOW_DIR/state/ready.json"
CONFIG_JSON="$WORKFLOW_DIR/config.json"
REQUEST_LOG="$WORKFLOW_DIR/state/request-log.md"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo "Usage: flow done <task-id> [commit-message]"
    exit 1
fi

TASK_ID="$1"
COMMIT_MSG="${2:-Complete $TASK_ID}"

if [ ! -f "$READY_JSON" ]; then
    echo -e "${RED}Error: No ready.json found${NC}"
    exit 1
fi

# Check quality gates from config
gates_passed=true

if [ -f "$CONFIG_JSON" ]; then
    echo -e "${YELLOW}Running quality gates...${NC}"
    echo ""
    
    # Parse config and run gates
    CONFIG_FILE="$CONFIG_JSON" REQUEST_LOG_FILE="$REQUEST_LOG" TASK_ID_ARG="$TASK_ID" python3 << 'GATES'
import json
import subprocess
import sys
import os

with open(os.environ['CONFIG_FILE']) as f:
    config = json.load(f)

task_id = os.environ['TASK_ID_ARG']
request_log = os.environ['REQUEST_LOG_FILE']
gates = config.get('qualityGates', {}).get('feature', {}).get('require', [])
testing = config.get('testing', {})
failed = []

for gate in gates:
    if gate == 'tests':
        if testing.get('runAfterTask', False) or testing.get('runBeforeCommit', False):
            print('  Running tests...')
            result = subprocess.run(['npm', 'test'], capture_output=True, text=True)
            if result.returncode == 0:
                print('  \033[0;32m✓\033[0m tests passed')
            else:
                print('  \033[0;31m✗\033[0m tests failed')
                failed.append('tests')
        else:
            print('  \033[0;33m○\033[0m tests (not configured to run)')

    elif gate == 'requestLogEntry':
        # Check if request-log has an entry for this task
        try:
            with open(request_log) as f:
                content = f.read()
            if task_id in content or content.strip().endswith('---'):
                print('  \033[0;33m○\033[0m requestLogEntry (verify manually)')
            else:
                print('  \033[0;33m○\033[0m requestLogEntry (verify manually)')
        except:
            print('  \033[0;33m○\033[0m requestLogEntry (verify manually)')

    elif gate == 'appMapUpdate':
        print('  \033[0;33m○\033[0m appMapUpdate (verify manually if components created)')

    else:
        print(f'  \033[0;33m○\033[0m {gate} (manual check)')

if failed:
    print(f'\n\033[0;31mFailed gates: {", ".join(failed)}\033[0m')
    sys.exit(1)
GATES
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Quality gates failed. Fix issues before completing.${NC}"
        exit 1
    fi
    echo ""
fi

READY_FILE="$READY_JSON" TASK_ID_ARG="$TASK_ID" python3 << 'EOF'
import json, os

task_id = os.environ['TASK_ID_ARG']
ready_file = os.environ['READY_FILE']

with open(ready_file) as f:
    data = json.load(f)

# Find task in inProgress
in_progress = data.get('inProgress', [])
found = None
found_idx = None

for i, task in enumerate(in_progress):
    if isinstance(task, dict):
        if task.get('id') == task_id:
            found = task
            found_idx = i
            break
    elif task == task_id:
        found = {'id': task_id}
        found_idx = i
        break

if found is None:
    print(f'\033[0;31mTask {task_id} not found in progress\033[0m')
    exit(1)

# Move to completed
in_progress.pop(found_idx)
data['inProgress'] = in_progress

completed = data.get('recentlyCompleted', [])
completed.insert(0, found)
data['recentlyCompleted'] = completed[:10]  # Keep last 10

# Update timestamp
from datetime import datetime
data['lastUpdated'] = datetime.now().isoformat()

with open(ready_file, 'w') as f:
    json.dump(data, f, indent=2)

print(f'\033[0;32m✓ Completed: {task_id}\033[0m')
EOF

# Commit if there are changes
if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
    echo ""
    echo -e "${YELLOW}Committing changes...${NC}"
    git add -A
    git commit -m "feat: $COMMIT_MSG"
    echo -e "${GREEN}✓ Changes committed${NC}"
fi

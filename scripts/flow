#!/bin/bash

# Wogi Flow - Main CLI
# Self-improving AI development workflow

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

show_version() {
    if [ -f "$PROJECT_ROOT/.wogi-version" ]; then
        echo "Wogi Flow v$(cat "$PROJECT_ROOT/.wogi-version")"
    else
        echo "Wogi Flow (version unknown)"
    fi
}

show_quick_help() {
    show_version
    echo ""
    echo "Quick Start:"
    echo "  flow install          # Set up workflow in project"
    echo "  flow ready            # See tasks ready to work on"
    echo "  flow start TASK-XXX   # Start a task"
    echo "  flow done TASK-XXX    # Complete a task"
    echo "  flow status           # Project overview"
    echo ""
    echo "Run 'flow help' for full command list"
    echo "Run 'flow help <command>' for command details"
}

show_help() {
    show_version
    echo ""
    echo "Usage: flow <command> [options]"
    echo ""
    echo "Setup & Updates:"
    echo "  install              Interactive setup wizard"
    echo "  install --quick      Quick setup with defaults"
    echo "  onboard              Analyze existing project & set up context"
    echo "  update               Update to latest version (preserves data)"
    echo "  update --check       Check for available updates"
    echo ""
    echo "Task Management:"
    echo "  ready                Show tasks ready to work on"
    echo "  start <task-id>      Start working on a task"
    echo "  done <task-id>       Mark task complete"
    echo "  status               Show project overview"
    echo "  deps <task-id>       Show task dependencies"
    echo ""
    echo "Story & Feature Creation:"
    echo "  story <title>        Create detailed story with acceptance criteria"
    echo "  new-feature <n>   Create new feature"
    echo "  bug <title>          Create bug report"
    echo ""
    echo "Workflow:"
    echo "  health               Check workflow health"
    echo "  verify <gate>        Run verification gate (lint, typecheck, test, build)"
    echo "  verify all           Run all verification gates"
    echo "  standup [days]       Generate standup summary"
    echo "  session-end          End session properly"
    echo "  init                 Initialize workflow (legacy)"
    echo "  setup-hooks          Install/manage git hooks"
    echo "  archive              Archive old request-log entries"
    echo "  watch                Run file watcher for auto-validation"
    echo ""
    echo "Components:"
    echo "  update-map           Add/scan components in app map"
    echo "  map-index            Auto-generate component index"
    echo "  map-index scan       Rescan codebase"
    echo "  map-sync             Compare index with app-map"
    echo ""
    echo "Skills & Learning:"
    echo "  skill-learn          Extract learnings from recent changes"
    echo "  skill-create <name>  Create a new skill"
    echo "  skill-create --list  List existing skills"
    echo "  skill detect         Detect frameworks in project"
    echo "  skill list           List installed skills"
    echo "  correct              Capture a correction/learning"
    echo "  correct \"desc\"       Quick mode with description"
    echo "  correct list         List recent corrections"
    echo "  aggregate            Aggregate learnings across skills"
    echo "  aggregate --promote  Interactive promotion wizard"
    echo ""
    echo "Code Traces:"
    echo "  trace \"<prompt>\"     Generate task-focused code trace"
    echo "  trace list           List saved traces"
    echo "  trace show <n>    Show a saved trace"
    echo ""
    echo "Run History:"
    echo "  run-trace start <n>  Start a new traced run"
    echo "  run-trace end        End current run"
    echo "  history [--limit N]  List recent runs"
    echo "  inspect <run-id>     Show run details"
    echo "  run-trace cleanup    Remove old runs"
    echo ""
    echo "Diff Preview:"
    echo "  diff <file1> <file2>           Show diff between files"
    echo "  diff --preview <ops.json>      Preview proposed changes"
    echo "  diff --apply <ops.json>        Apply changes from JSON"
    echo "  diff --dry-run <ops.json>      Show diff without prompting"
    echo ""
    echo "Checkpoints:"
    echo "  checkpoint create [msg]        Create manual checkpoint"
    echo "  checkpoint list                List all checkpoints"
    echo "  checkpoint rollback <id>       Rollback to checkpoint"
    echo "  checkpoint cleanup             Remove old checkpoints"
    echo ""
    echo "Search & Context:"
    echo "  search <query>       Search request-log by tag/keyword"
    echo "  context <task-id>    Load all context for a task"
    echo "  links list           List external links"
    echo "  links fetch <name>   Fetch and cache link content"
    echo "  links add <n> <url>  Add external link"
    echo ""
    echo "Team & Collaboration:"
    echo "  team login <code>    Join team with invite code"
    echo "  team logout          Leave current team"
    echo "  team setup           List/select team setups"
    echo "  team sync            Sync knowledge with team (project-scoped)"
    echo "  team sync-status     Show sync status for project"
    echo "  team sync-init <id>  Initialize project-based sync"
    echo "  team proposals       View/vote on proposals"
    echo "  team status          Show team status"
    echo "  export-profile       Export workflow config for team"
    echo "  import-profile       Import team config"
    echo ""
    echo "PRD Management:"
    echo "  prd load <file>      Load PRD into memory"
    echo "  prd context <task>   Get PRD context for task"
    echo "  prd list             List loaded PRDs"
    echo "  prd clear            Clear PRD data"
    echo ""
    echo "Docs:"
    echo "  changelog            Generate changelog from request-log"
    echo ""
    echo "Parallel Execution:"
    echo "  parallel config      Show parallel execution config"
    echo "  parallel check       Check tasks for parallel potential"
    echo "  parallel analyze     Analyze tasks for parallel potential"
    echo "  parallel suggest     Check if parallel should be suggested"
    echo "  parallel enable      Enable parallel execution"
    echo "  parallel disable     Disable parallel execution"
    echo ""
    echo "Loop Enforcement:"
    echo "  loop status          Show active loop session"
    echo "  loop stats           Show loop statistics"
    echo "  loop can-exit        Check if current loop can exit"
    echo ""
    echo "Worktree Isolation:"
    echo "  worktree enable      Enable worktree isolation for tasks"
    echo "  worktree disable     Disable worktree isolation"
    echo "  worktree list        List active task worktrees"
    echo "  worktree cleanup     Remove stale worktrees"
    echo ""
    echo "Figma Analyzer:"
    echo "  figma scan           Scan codebase for components"
    echo "  figma show [name]    Show component details"
    echo "  figma extract <file> Extract from Figma data"
    echo "  figma match <file>   Match against registry"
    echo "  figma confirm <file> Interactive confirmation"
    echo "  figma generate       Generate code from decisions"
    echo "  figma server [port]  Start MCP server"
    echo ""
    echo "Hybrid Mode:"
    echo "  hybrid enable        Enable hybrid mode (Claude plans, local LLM executes)"
    echo "  hybrid disable       Disable hybrid mode"
    echo "  hybrid status        Show hybrid mode status"
    echo "  hybrid execute       Execute a plan file"
    echo "  hybrid rollback      Rollback last execution"
    echo "  hybrid test          Test hybrid mode installation"
    echo "  templates generate   Generate project-specific templates"
    echo ""
    echo "Model Providers:"
    echo "  providers list       List all available providers"
    echo "  providers detect     Detect running local providers"
    echo "  providers test <t>   Test a provider connection"
    echo ""
    echo "Declarative Workflows:"
    echo "  workflow list        List available workflows"
    echo "  workflow run <name>  Run a workflow"
    echo "  workflow create <n>  Create workflow template"
    echo ""
    echo "Metrics & Analysis:"
    echo "  metrics              Show command success/failure stats"
    echo "  metrics --problems   Show only problematic commands"
    echo "  metrics --reset      Clear all metrics"
    echo "  insights             Generate codebase insights report"
    echo "  auto-context \"task\"  Preview context that would be loaded"
    echo "  model-adapter        Show current model adapter info"
    echo "  model-adapter --stats Show per-model statistics"
    echo "  multi-approach       Start multi-approach session"
    echo "  multi-approach --analyze \"task\" Analyze without starting"
    echo "  complexity \"task\"    Assess task complexity and token estimate"
    echo "  safety               Run security scan on codebase"
    echo "  context-init \"task\"  Initialize context for a task"
    echo ""
    echo "Memory & Knowledge (v1.8):"
    echo "  memory search <query>  Search stored facts"
    echo "  memory stats           Show memory statistics"
    echo "  memory-server          Start MCP memory server"
    echo "  entropy                Show memory entropy stats"
    echo "  entropy --auto         Auto-compact if entropy high"
    echo "  entropy --history      Show entropy history"
    echo "  compact-memory         Run full memory compaction"
    echo "  compact-memory --preview Show what would be affected"
    echo "  memory-sync            Check patterns for promotion"
    echo "  memory-sync --auto     Auto-promote to decisions.md"
    echo "  knowledge-route <text> Detect route for a learning"
    echo "  knowledge-route store  Store a learning with route"
    echo "  log-manager status     Show request-log statistics"
    echo "  log-manager archive    Archive old log entries"
    echo ""
    echo "Options:"
    echo "  help, --help, -h     Show this help"
    echo "  version, --version   Show version"
}

case "${1:-}" in
    ready)
        node "$SCRIPT_DIR/flow-ready.js" "${@:2}"
        ;;
    start)
        node "$SCRIPT_DIR/flow-start.js" "${@:2}"
        ;;
    done)
        node "$SCRIPT_DIR/flow-done.js" "${@:2}"
        ;;
    story)
        "$SCRIPT_DIR/flow-story" "${@:2}"
        ;;
    new-feature)
        "$SCRIPT_DIR/flow-new-feature" "${@:2}"
        ;;
    bug)
        "$SCRIPT_DIR/flow-bug" "${@:2}"
        ;;
    status)
        node "$SCRIPT_DIR/flow-status.js" "${@:2}"
        ;;
    deps)
        "$SCRIPT_DIR/flow-deps" "${@:2}"
        ;;
    health)
        node "$SCRIPT_DIR/flow-health.js" "${@:2}"
        ;;
    safety)
        node "$SCRIPT_DIR/flow-safety.js" "${@:2}"
        ;;
    verify)
        node "$SCRIPT_DIR/flow-verify.js" "${@:2}"
        ;;
    run-trace)
        node "$SCRIPT_DIR/flow-run-trace.js" "${@:2}"
        ;;
    history)
        node "$SCRIPT_DIR/flow-run-trace.js" list "${@:2}"
        ;;
    inspect)
        node "$SCRIPT_DIR/flow-run-trace.js" inspect "${@:2}"
        ;;
    diff)
        node "$SCRIPT_DIR/flow-diff.js" "${@:2}"
        ;;
    checkpoint)
        node "$SCRIPT_DIR/flow-checkpoint.js" "${@:2}"
        ;;
    standup)
        "$SCRIPT_DIR/flow-standup" "${@:2}"
        ;;
    session-end)
        node "$SCRIPT_DIR/flow-session-end.js" "${@:2}"
        ;;
    init)
        "$SCRIPT_DIR/flow-init" "${@:2}"
        ;;
    install)
        "$SCRIPT_DIR/flow-install" "${@:2}"
        ;;
    onboard)
        "$SCRIPT_DIR/flow-onboard" "${@:2}"
        ;;
    update)
        "$SCRIPT_DIR/flow-update" "${@:2}"
        ;;
    setup-hooks)
        "$SCRIPT_DIR/flow-setup-hooks" "${@:2}"
        ;;
    update-map)
        "$SCRIPT_DIR/flow-update-map" "${@:2}"
        ;;
    map-index)
        "$SCRIPT_DIR/flow-map-index" "${@:2}"
        ;;
    map-sync)
        "$SCRIPT_DIR/flow-map-sync" "${@:2}"
        ;;
    skill-learn)
        node "$SCRIPT_DIR/flow-skill-learn.js" "${@:2}"
        ;;
    correct)
        node "$SCRIPT_DIR/flow-correct.js" "${@:2}"
        ;;
    aggregate)
        node "$SCRIPT_DIR/flow-aggregate.js" "${@:2}"
        ;;
    skill-create)
        node "$SCRIPT_DIR/flow-skill-create.js" "${@:2}"
        ;;
    trace)
        "$SCRIPT_DIR/flow-trace" "${@:2}"
        ;;
    search)
        "$SCRIPT_DIR/flow-search" "${@:2}"
        ;;
    context)
        "$SCRIPT_DIR/flow-context" "${@:2}"
        ;;
    links)
        node "$SCRIPT_DIR/flow-links.js" "${@:2}"
        ;;
    context-init)
        node "$SCRIPT_DIR/flow-context-init.js" "${@:2}"
        ;;
    export-profile)
        "$SCRIPT_DIR/flow-export-profile" "${@:2}"
        ;;
    import-profile)
        "$SCRIPT_DIR/flow-import-profile" "${@:2}"
        ;;
    changelog)
        "$SCRIPT_DIR/flow-changelog" "${@:2}"
        ;;
    archive)
        "$SCRIPT_DIR/flow-archive" "${@:2}"
        ;;
    watch)
        "$SCRIPT_DIR/flow-watch" "${@:2}"
        ;;
    parallel)
        case "${2:-config}" in
            config)
                node "$SCRIPT_DIR/flow-parallel.js" config
                ;;
            check)
                node "$SCRIPT_DIR/flow-parallel.js" check
                ;;
            analyze)
                node "$SCRIPT_DIR/flow-parallel-detector.js" analyze
                ;;
            suggest)
                node "$SCRIPT_DIR/flow-parallel-detector.js" suggest
                ;;
            enable)
                node "$SCRIPT_DIR/flow-config-set.js" parallel.enabled true
                ;;
            disable)
                node "$SCRIPT_DIR/flow-config-set.js" parallel.enabled false
                ;;
            auto-approve)
                node "$SCRIPT_DIR/flow-config-set.js" parallel.autoApprove true
                ;;
            *)
                echo "Usage: flow parallel [config|check|analyze|suggest|enable|disable|auto-approve]"
                ;;
        esac
        ;;
    loop)
        case "${2:-status}" in
            status)
                node "$SCRIPT_DIR/flow-loop-enforcer.js" status
                ;;
            stats)
                node "$SCRIPT_DIR/flow-loop-enforcer.js" stats
                ;;
            can-exit)
                node "$SCRIPT_DIR/flow-loop-enforcer.js" can-exit
                ;;
            enable)
                node "$SCRIPT_DIR/flow-config-set.js" loops.enforced true
                echo "Loop enforcement enabled (Ralph Wiggum mode)"
                ;;
            disable)
                node "$SCRIPT_DIR/flow-config-set.js" loops.enforced false
                ;;
            *)
                echo "Usage: flow loop [status|stats|can-exit|enable|disable]"
                ;;
        esac
        ;;
    skill)
        case "${2:-list}" in
            detect)
                node "$SCRIPT_DIR/flow-skill-creator.js" detect
                ;;
            list)
                node "$SCRIPT_DIR/flow-skill-creator.js" list
                ;;
            create)
                if [ -z "$3" ]; then
                    echo "Usage: flow skill create <framework>"
                else
                    node "$SCRIPT_DIR/flow-skill-creator.js" create "$3"
                fi
                ;;
            *)
                echo "Usage: flow skill [detect|list|create <name>]"
                ;;
        esac
        ;;
    worktree)
        case "${2:-list}" in
            enable)
                node "$SCRIPT_DIR/flow-config-set.js" worktree.enabled true
                echo "Tasks will now run in isolated git worktrees for safe parallel execution"
                ;;
            disable)
                node "$SCRIPT_DIR/flow-config-set.js" worktree.enabled false
                ;;
            list)
                node "$SCRIPT_DIR/flow-worktree.js" list
                ;;
            cleanup)
                node "$SCRIPT_DIR/flow-worktree.js" cleanup
                ;;
            status)
                node "$SCRIPT_DIR/flow-config-set.js" worktree
                ;;
            *)
                echo "Usage: flow worktree [enable|disable|list|cleanup|status]"
                ;;
        esac
        ;;
    hybrid)
        case "${2:-status}" in
            setup)
                echo "ðŸ”§ Setting up Hybrid Mode..."
                echo ""
                echo "Step 1: Generating project templates..."
                node "$SCRIPT_DIR/flow-templates.js" generate
                echo ""
                echo "Step 2: Configuring local LLM..."
                node "$SCRIPT_DIR/flow-hybrid-interactive.js"
                ;;
            enable)
                node "$SCRIPT_DIR/flow-hybrid-interactive.js"
                ;;
            disable)
                node "$SCRIPT_DIR/flow-config-set.js" hybrid.enabled false
                ;;
            status)
                node "$SCRIPT_DIR/flow-config-set.js" hybrid
                ;;
            execute)
                node "$SCRIPT_DIR/flow-orchestrate.js" "$3"
                ;;
            rollback)
                node "$SCRIPT_DIR/flow-orchestrate.js" --rollback
                ;;
            test)
                node "$SCRIPT_DIR/flow-hybrid-test.js"
                ;;
            *)
                echo "Usage: flow hybrid [enable|disable|status|execute|rollback|test]"
                ;;
        esac
        ;;
    figma)
        case "${2:-help}" in
            scan)
                node "$SCRIPT_DIR/flow-figma-index.js" scan
                ;;
            show)
                node "$SCRIPT_DIR/flow-figma-index.js" show "$3"
                ;;
            export)
                node "$SCRIPT_DIR/flow-figma-index.js" export
                ;;
            extract)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-extract.js"
                else
                    node "$SCRIPT_DIR/flow-figma-extract.js" "$3"
                fi
                ;;
            match)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-match.js"
                else
                    node "$SCRIPT_DIR/flow-figma-match.js" "$3"
                fi
                ;;
            confirm)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-confirm.js"
                else
                    node "$SCRIPT_DIR/flow-figma-confirm.js" "$3" "${@:4}"
                fi
                ;;
            generate)
                node "$SCRIPT_DIR/flow-figma-generate.js" "$3"
                ;;
            server)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-mcp-server.js" --http
                else
                    node "$SCRIPT_DIR/flow-figma-mcp-server.js" --http "$3"
                fi
                ;;
            analyze)
                # Full pipeline: extract + match
                if [ -z "$3" ]; then
                    echo "Usage: flow figma analyze <figma-data.json>"
                    exit 1
                fi
                node "$SCRIPT_DIR/flow-figma-extract.js" "$3" | \
                node "$SCRIPT_DIR/flow-figma-match.js" --stdin
                ;;
            *)
                echo ""
                echo "Figma Component Analyzer:"
                echo "  figma scan              Scan codebase for components"
                echo "  figma show [name]       Show component details (or list all)"
                echo "  figma extract <file>    Extract from Figma MCP data"
                echo "  figma match <file>      Match against registry"
                echo "  figma analyze <file>    Extract + match (full pipeline)"
                echo "  figma confirm <file>    Interactive confirmation"
                echo "  figma generate [file]   Generate code from decisions"
                echo "  figma server [port]     Start MCP server (default: 3847)"
                echo ""
                ;;
        esac
        ;;
    templates)
        node "$SCRIPT_DIR/flow-templates.js" "${2:-generate}"
        ;;
    providers)
        node "$SCRIPT_DIR/flow-providers.js" "${@:2}"
        ;;
    workflow)
        node "$SCRIPT_DIR/flow-workflow.js" "${@:2}"
        ;;
    metrics)
        node "$SCRIPT_DIR/flow-metrics.js" "${@:2}"
        ;;
    insights)
        node "$SCRIPT_DIR/flow-project-analyzer.js" --insights "${@:2}"
        ;;
    auto-context)
        node "$SCRIPT_DIR/flow-auto-context.js" "${@:2}"
        ;;
    model-adapter)
        node "$SCRIPT_DIR/flow-model-adapter.js" "${@:2}"
        ;;
    multi-approach)
        node "$SCRIPT_DIR/flow-multi-approach.js" "${@:2}"
        ;;
    complexity)
        node "$SCRIPT_DIR/flow-complexity.js" "${@:2}"
        ;;
    memory)
        case "${2:-stats}" in
            search)
                # Search facts in memory - requires MCP server or direct DB access
                echo "Memory search requires MCP server running."
                echo "Start server with: flow memory-server"
                echo "Or use the MCP client to call recall_facts tool."
                ;;
            stats)
                # Show memory statistics
                if [ -f "$PROJECT_ROOT/.workflow/memory/local.db" ]; then
                    echo "Memory Statistics:"
                    sqlite3 "$PROJECT_ROOT/.workflow/memory/local.db" "SELECT 'Facts: ' || COUNT(*) FROM facts; SELECT 'Proposals: ' || COUNT(*) FROM proposals; SELECT 'PRD Chunks: ' || COUNT(*) FROM prd_chunks;" 2>/dev/null || echo "  Database not initialized. Run memory-server first."
                else
                    echo "Memory database not found. Start MCP server to initialize."
                fi
                ;;
            *)
                echo "Usage: flow memory [search|stats]"
                ;;
        esac
        ;;
    memory-server)
        echo "Starting MCP Memory Server..."
        node "$PROJECT_ROOT/mcp-memory-server/index.js"
        ;;
    entropy)
        node "$SCRIPT_DIR/flow-entropy-monitor.js" "${@:2}"
        ;;
    compact-memory)
        node "$SCRIPT_DIR/flow-memory-compactor.js" "${@:2}"
        ;;
    memory-sync)
        node "$SCRIPT_DIR/flow-memory-sync.js" "${@:2}"
        ;;
    knowledge-route)
        case "${2:-}" in
            detect|"")
                if [ -z "$3" ]; then
                    echo "Usage: flow knowledge-route detect \"<text>\""
                else
                    node "$SCRIPT_DIR/flow-knowledge-router.js" detect "${@:3}"
                fi
                ;;
            store)
                if [ -z "$3" ] || [ -z "$4" ]; then
                    echo "Usage: flow knowledge-route store \"<text>\" <route-type>"
                    echo "Route types: model-specific, skill:<name>, project, team"
                else
                    node "$SCRIPT_DIR/flow-knowledge-router.js" store "${@:3}"
                fi
                ;;
            show)
                if [ -z "$3" ]; then
                    echo "Usage: flow knowledge-route show \"<text>\""
                else
                    node "$SCRIPT_DIR/flow-knowledge-router.js" show "${@:3}"
                fi
                ;;
            routes)
                node "$SCRIPT_DIR/flow-knowledge-router.js" routes
                ;;
            *)
                echo "Usage: flow knowledge-route [detect|store|show|routes]"
                ;;
        esac
        ;;
    log-manager)
        node "$SCRIPT_DIR/flow-log-manager.js" "${@:2}"
        ;;
    team)
        case "${2:-status}" in
            sync-status)
                node "$SCRIPT_DIR/flow-team-sync.js" status
                ;;
            sync-init)
                if [ -z "$3" ]; then
                    echo "Usage: flow team sync-init <team-id>"
                else
                    node "$SCRIPT_DIR/flow-team-sync.js" init "$3"
                fi
                ;;
            sync-payload)
                node "$SCRIPT_DIR/flow-team-sync.js" payload
                ;;
            project-id)
                node "$SCRIPT_DIR/flow-team-sync.js" project-id
                ;;
            *)
                # Delegate to original team handler for other commands
                node "$SCRIPT_DIR/flow-team.js" "${@:2}"
                ;;
        esac
        ;;
    prd)
        node "$SCRIPT_DIR/flow-prd-manager.js" "${@:2}"
        ;;
    voice-input|voice)
        node "$SCRIPT_DIR/flow-voice-input.js" "${@:2}"
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h)
        case "${2:-}" in
            --quick|-q)
                show_quick_help
                ;;
            "")
                show_help
                ;;
            *)
                # Show help for specific command
                echo "Help for: $2"
                echo ""
                case "$2" in
                    ready) echo "Show tasks ready to work on. Reads from .workflow/state/ready.json" ;;
                    start) echo "Start working on a task. Usage: flow start TASK-XXX" ;;
                    done) echo "Complete a task, run quality gates. Usage: flow done TASK-XXX" ;;
                    status) echo "Show project overview: tasks, git status, recent activity" ;;
                    health) echo "Check workflow health: validate config, check files" ;;
                    story) echo "Create detailed story with acceptance criteria. Usage: flow story \"title\"" ;;
                    hybrid) echo "Manage hybrid mode. Subcommands: enable, disable, status, execute, test" ;;
                    parallel) echo "Manage parallel execution. Subcommands: config, check, enable, disable" ;;
                    worktree) echo "Manage worktree isolation. Subcommands: enable, disable, list, cleanup" ;;
                    voice-input|voice) echo "Voice-to-transcript input. Subcommands: setup, status, test, record" ;;
                    *) echo "No detailed help for '$2'. Run 'flow help' for all commands." ;;
                esac
                ;;
        esac
        ;;
    *)
        show_quick_help
        echo ""
        echo "Unknown command: ${1:-}"
        exit 1
        ;;
esac

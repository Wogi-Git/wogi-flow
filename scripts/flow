#!/bin/bash

# Wogi Flow - Main CLI
# Self-improving AI development workflow

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

show_version() {
    if [ -f "$PROJECT_ROOT/.wogi-version" ]; then
        echo "Wogi Flow v$(cat "$PROJECT_ROOT/.wogi-version")"
    else
        echo "Wogi Flow (version unknown)"
    fi
}

show_help() {
    show_version
    echo ""
    echo "Usage: flow <command> [options]"
    echo ""
    echo "Setup & Updates:"
    echo "  install              Interactive setup wizard"
    echo "  install --quick      Quick setup with defaults"
    echo "  onboard              Analyze existing project & set up context"
    echo "  update               Update to latest version (preserves data)"
    echo "  update --check       Check for available updates"
    echo ""
    echo "Task Management:"
    echo "  ready                Show tasks ready to work on"
    echo "  start <task-id>      Start working on a task"
    echo "  done <task-id>       Mark task complete"
    echo "  status               Show project overview"
    echo "  deps <task-id>       Show task dependencies"
    echo ""
    echo "Story & Feature Creation:"
    echo "  story <title>        Create detailed story with acceptance criteria"
    echo "  new-feature <n>   Create new feature"
    echo "  bug <title>          Create bug report"
    echo ""
    echo "Workflow:"
    echo "  health               Check workflow health"
    echo "  verify <gate>        Run verification gate (lint, typecheck, test, build)"
    echo "  verify all           Run all verification gates"
    echo "  standup [days]       Generate standup summary"
    echo "  session-end          End session properly"
    echo "  init                 Initialize workflow (legacy)"
    echo "  setup-hooks          Install/manage git hooks"
    echo "  archive              Archive old request-log entries"
    echo "  watch                Run file watcher for auto-validation"
    echo ""
    echo "Components:"
    echo "  update-map           Add/scan components in app map"
    echo "  map-index            Auto-generate component index"
    echo "  map-index scan       Rescan codebase"
    echo "  map-sync             Compare index with app-map"
    echo ""
    echo "Skills & Learning:"
    echo "  skill-learn          Extract learnings from recent changes"
    echo "  skill-create <name>  Create a new skill"
    echo "  skill-create --list  List existing skills"
    echo "  correct              Capture a correction/learning"
    echo "  correct \"desc\"       Quick mode with description"
    echo "  correct list         List recent corrections"
    echo "  aggregate            Aggregate learnings across skills"
    echo "  aggregate --promote  Interactive promotion wizard"
    echo ""
    echo "Code Traces:"
    echo "  trace \"<prompt>\"     Generate task-focused code trace"
    echo "  trace list           List saved traces"
    echo "  trace show <n>    Show a saved trace"
    echo ""
    echo "Run History:"
    echo "  run-trace start <n>  Start a new traced run"
    echo "  run-trace end        End current run"
    echo "  history [--limit N]  List recent runs"
    echo "  inspect <run-id>     Show run details"
    echo "  run-trace cleanup    Remove old runs"
    echo ""
    echo "Diff Preview:"
    echo "  diff <file1> <file2>           Show diff between files"
    echo "  diff --preview <ops.json>      Preview proposed changes"
    echo "  diff --apply <ops.json>        Apply changes from JSON"
    echo "  diff --dry-run <ops.json>      Show diff without prompting"
    echo ""
    echo "Checkpoints:"
    echo "  checkpoint create [msg]        Create manual checkpoint"
    echo "  checkpoint list                List all checkpoints"
    echo "  checkpoint rollback <id>       Rollback to checkpoint"
    echo "  checkpoint cleanup             Remove old checkpoints"
    echo ""
    echo "Search & Context:"
    echo "  search <query>       Search request-log by tag/keyword"
    echo "  context <task-id>    Load all context for a task"
    echo "  links list           List external links"
    echo "  links fetch <name>   Fetch and cache link content"
    echo "  links add <n> <url>  Add external link"
    echo ""
    echo "Team:"
    echo "  export-profile       Export workflow config for team"
    echo "  import-profile       Import team config"
    echo ""
    echo "Docs:"
    echo "  changelog            Generate changelog from request-log"
    echo ""
    echo "Parallel Execution:"
    echo "  parallel config      Show parallel execution config"
    echo "  parallel check       Check tasks for parallel potential"
    echo "  parallel enable      Enable parallel execution"
    echo "  parallel disable     Disable parallel execution"
    echo ""
    echo "Worktree Isolation:"
    echo "  worktree enable      Enable worktree isolation for tasks"
    echo "  worktree disable     Disable worktree isolation"
    echo "  worktree list        List active task worktrees"
    echo "  worktree cleanup     Remove stale worktrees"
    echo ""
    echo "Figma Analyzer:"
    echo "  figma scan           Scan codebase for components"
    echo "  figma show [name]    Show component details"
    echo "  figma extract <file> Extract from Figma data"
    echo "  figma match <file>   Match against registry"
    echo "  figma confirm <file> Interactive confirmation"
    echo "  figma generate       Generate code from decisions"
    echo "  figma server [port]  Start MCP server"
    echo ""
    echo "Hybrid Mode:"
    echo "  hybrid enable        Enable hybrid mode (Claude plans, local LLM executes)"
    echo "  hybrid disable       Disable hybrid mode"
    echo "  hybrid status        Show hybrid mode status"
    echo "  hybrid execute       Execute a plan file"
    echo "  hybrid rollback      Rollback last execution"
    echo "  hybrid test          Test hybrid mode installation"
    echo "  templates generate   Generate project-specific templates"
    echo ""
    echo "Model Providers:"
    echo "  providers list       List all available providers"
    echo "  providers detect     Detect running local providers"
    echo "  providers test <t>   Test a provider connection"
    echo ""
    echo "Declarative Workflows:"
    echo "  workflow list        List available workflows"
    echo "  workflow run <name>  Run a workflow"
    echo "  workflow create <n>  Create workflow template"
    echo ""
    echo "Options:"
    echo "  help, --help, -h     Show this help"
    echo "  version, --version   Show version"
}

case "${1:-}" in
    ready)
        node "$SCRIPT_DIR/flow-ready.js" "${@:2}"
        ;;
    start)
        node "$SCRIPT_DIR/flow-start.js" "${@:2}"
        ;;
    done)
        node "$SCRIPT_DIR/flow-done.js" "${@:2}"
        ;;
    story)
        "$SCRIPT_DIR/flow-story" "${@:2}"
        ;;
    new-feature)
        "$SCRIPT_DIR/flow-new-feature" "${@:2}"
        ;;
    bug)
        "$SCRIPT_DIR/flow-bug" "${@:2}"
        ;;
    status)
        node "$SCRIPT_DIR/flow-status.js" "${@:2}"
        ;;
    deps)
        "$SCRIPT_DIR/flow-deps" "${@:2}"
        ;;
    health)
        node "$SCRIPT_DIR/flow-health.js" "${@:2}"
        ;;
    safety)
        node "$SCRIPT_DIR/flow-safety.js" "${@:2}"
        ;;
    verify)
        node "$SCRIPT_DIR/flow-verify.js" "${@:2}"
        ;;
    run-trace)
        node "$SCRIPT_DIR/flow-run-trace.js" "${@:2}"
        ;;
    history)
        node "$SCRIPT_DIR/flow-run-trace.js" list "${@:2}"
        ;;
    inspect)
        node "$SCRIPT_DIR/flow-run-trace.js" inspect "${@:2}"
        ;;
    diff)
        node "$SCRIPT_DIR/flow-diff.js" "${@:2}"
        ;;
    checkpoint)
        node "$SCRIPT_DIR/flow-checkpoint.js" "${@:2}"
        ;;
    standup)
        "$SCRIPT_DIR/flow-standup" "${@:2}"
        ;;
    session-end)
        node "$SCRIPT_DIR/flow-session-end.js" "${@:2}"
        ;;
    init)
        "$SCRIPT_DIR/flow-init" "${@:2}"
        ;;
    install)
        "$SCRIPT_DIR/flow-install" "${@:2}"
        ;;
    onboard)
        "$SCRIPT_DIR/flow-onboard" "${@:2}"
        ;;
    update)
        "$SCRIPT_DIR/flow-update" "${@:2}"
        ;;
    setup-hooks)
        "$SCRIPT_DIR/flow-setup-hooks" "${@:2}"
        ;;
    update-map)
        "$SCRIPT_DIR/flow-update-map" "${@:2}"
        ;;
    map-index)
        "$SCRIPT_DIR/flow-map-index" "${@:2}"
        ;;
    map-sync)
        "$SCRIPT_DIR/flow-map-sync" "${@:2}"
        ;;
    skill-learn)
        node "$SCRIPT_DIR/flow-skill-learn.js" "${@:2}"
        ;;
    correct)
        node "$SCRIPT_DIR/flow-correct.js" "${@:2}"
        ;;
    aggregate)
        node "$SCRIPT_DIR/flow-aggregate.js" "${@:2}"
        ;;
    skill-create)
        node "$SCRIPT_DIR/flow-skill-create.js" "${@:2}"
        ;;
    trace)
        "$SCRIPT_DIR/flow-trace" "${@:2}"
        ;;
    search)
        "$SCRIPT_DIR/flow-search" "${@:2}"
        ;;
    context)
        "$SCRIPT_DIR/flow-context" "${@:2}"
        ;;
    links)
        node "$SCRIPT_DIR/flow-links.js" "${@:2}"
        ;;
    context-init)
        node "$SCRIPT_DIR/flow-context-init.js" "${@:2}"
        ;;
    export-profile)
        "$SCRIPT_DIR/flow-export-profile" "${@:2}"
        ;;
    import-profile)
        "$SCRIPT_DIR/flow-import-profile" "${@:2}"
        ;;
    changelog)
        "$SCRIPT_DIR/flow-changelog" "${@:2}"
        ;;
    archive)
        "$SCRIPT_DIR/flow-archive" "${@:2}"
        ;;
    watch)
        "$SCRIPT_DIR/flow-watch" "${@:2}"
        ;;
    parallel)
        case "${2:-config}" in
            config)
                node "$SCRIPT_DIR/flow-parallel.js" config
                ;;
            check)
                node "$SCRIPT_DIR/flow-parallel.js" check
                ;;
            enable)
                jq '.parallel.enabled = true' "$PROJECT_ROOT/.workflow/config.json" > /tmp/cfg.tmp && mv /tmp/cfg.tmp "$PROJECT_ROOT/.workflow/config.json"
                echo "âœ… Parallel execution enabled"
                ;;
            disable)
                jq '.parallel.enabled = false' "$PROJECT_ROOT/.workflow/config.json" > /tmp/cfg.tmp && mv /tmp/cfg.tmp "$PROJECT_ROOT/.workflow/config.json"
                echo "âœ… Parallel execution disabled"
                ;;
            auto-approve)
                jq '.parallel.autoApprove = true' "$PROJECT_ROOT/.workflow/config.json" > /tmp/cfg.tmp && mv /tmp/cfg.tmp "$PROJECT_ROOT/.workflow/config.json"
                echo "âœ… Parallel auto-approve enabled"
                ;;
            *)
                echo "Usage: flow parallel [config|check|enable|disable|auto-approve]"
                ;;
        esac
        ;;
    worktree)
        case "${2:-list}" in
            enable)
                jq '.worktree.enabled = true' "$PROJECT_ROOT/.workflow/config.json" > /tmp/cfg.tmp && mv /tmp/cfg.tmp "$PROJECT_ROOT/.workflow/config.json"
                echo "âœ… Worktree isolation enabled"
                echo "Tasks will now run in isolated git worktrees for safe parallel execution"
                ;;
            disable)
                jq '.worktree.enabled = false' "$PROJECT_ROOT/.workflow/config.json" > /tmp/cfg.tmp && mv /tmp/cfg.tmp "$PROJECT_ROOT/.workflow/config.json"
                echo "âœ… Worktree isolation disabled"
                ;;
            list)
                node "$SCRIPT_DIR/flow-worktree.js" list
                ;;
            cleanup)
                node "$SCRIPT_DIR/flow-worktree.js" cleanup
                ;;
            status)
                jq '.worktree' "$PROJECT_ROOT/.workflow/config.json"
                ;;
            *)
                echo "Usage: flow worktree [enable|disable|list|cleanup|status]"
                ;;
        esac
        ;;
    hybrid)
        case "${2:-status}" in
            setup)
                echo "ðŸ”§ Setting up Hybrid Mode..."
                echo ""
                echo "Step 1: Generating project templates..."
                node "$SCRIPT_DIR/flow-templates.js" generate
                echo ""
                echo "Step 2: Configuring local LLM..."
                node "$SCRIPT_DIR/flow-hybrid-interactive.js"
                ;;
            enable)
                node "$SCRIPT_DIR/flow-hybrid-interactive.js"
                ;;
            disable)
                jq '.hybrid.enabled = false' "$PROJECT_ROOT/.workflow/config.json" > /tmp/cfg.tmp && mv /tmp/cfg.tmp "$PROJECT_ROOT/.workflow/config.json"
                echo "âœ… Hybrid mode disabled"
                ;;
            status)
                jq '.hybrid' "$PROJECT_ROOT/.workflow/config.json"
                ;;
            execute)
                node "$SCRIPT_DIR/flow-orchestrate.js" "$3"
                ;;
            rollback)
                node "$SCRIPT_DIR/flow-orchestrate.js" --rollback
                ;;
            test)
                node "$SCRIPT_DIR/flow-hybrid-test.js"
                ;;
            *)
                echo "Usage: flow hybrid [enable|disable|status|execute|rollback|test]"
                ;;
        esac
        ;;
    figma)
        case "${2:-help}" in
            scan)
                node "$SCRIPT_DIR/flow-figma-index.js" scan
                ;;
            show)
                node "$SCRIPT_DIR/flow-figma-index.js" show "$3"
                ;;
            export)
                node "$SCRIPT_DIR/flow-figma-index.js" export
                ;;
            extract)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-extract.js"
                else
                    node "$SCRIPT_DIR/flow-figma-extract.js" "$3"
                fi
                ;;
            match)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-match.js"
                else
                    node "$SCRIPT_DIR/flow-figma-match.js" "$3"
                fi
                ;;
            confirm)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-confirm.js"
                else
                    node "$SCRIPT_DIR/flow-figma-confirm.js" "$3" "${@:4}"
                fi
                ;;
            generate)
                node "$SCRIPT_DIR/flow-figma-generate.js" "$3"
                ;;
            server)
                if [ -z "$3" ]; then
                    node "$SCRIPT_DIR/flow-figma-mcp-server.js" --http
                else
                    node "$SCRIPT_DIR/flow-figma-mcp-server.js" --http "$3"
                fi
                ;;
            analyze)
                # Full pipeline: extract + match
                if [ -z "$3" ]; then
                    echo "Usage: flow figma analyze <figma-data.json>"
                    exit 1
                fi
                node "$SCRIPT_DIR/flow-figma-extract.js" "$3" | \
                node "$SCRIPT_DIR/flow-figma-match.js" --stdin
                ;;
            *)
                echo ""
                echo "Figma Component Analyzer:"
                echo "  figma scan              Scan codebase for components"
                echo "  figma show [name]       Show component details (or list all)"
                echo "  figma extract <file>    Extract from Figma MCP data"
                echo "  figma match <file>      Match against registry"
                echo "  figma analyze <file>    Extract + match (full pipeline)"
                echo "  figma confirm <file>    Interactive confirmation"
                echo "  figma generate [file]   Generate code from decisions"
                echo "  figma server [port]     Start MCP server (default: 3847)"
                echo ""
                ;;
        esac
        ;;
    templates)
        node "$SCRIPT_DIR/flow-templates.js" "${2:-generate}"
        ;;
    providers)
        node "$SCRIPT_DIR/flow-providers.js" "${@:2}"
        ;;
    workflow)
        node "$SCRIPT_DIR/flow-workflow.js" "${@:2}"
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        show_help
        exit 1
        ;;
esac

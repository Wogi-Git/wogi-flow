#!/bin/bash

# Wogi Flow - Create Story
# Generate a detailed story template

set -e

WORKFLOW_DIR=".workflow"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo "Usage: flow story <title> [feature-name]"
    echo ""
    echo "Creates a detailed story with acceptance criteria template."
    echo ""
    echo "Examples:"
    echo "  flow story \"Add forgot password link\""
    echo "  flow story \"User profile page\" user-management"
    exit 1
fi

TITLE="$1"
FEATURE="${2:-general}"
FEATURE_DIR="$WORKFLOW_DIR/changes/$FEATURE"

# Create feature dir if needed
mkdir -p "$FEATURE_DIR"

# Find next task number
if [ -f "$FEATURE_DIR/tasks.json" ]; then
    LAST_NUM=$(grep -oE '"id": "TASK-[0-9]+"' "$FEATURE_DIR/tasks.json" | grep -oE '[0-9]+' | sort -n | tail -1 || echo "0")
else
    LAST_NUM=0
fi
NEXT_NUM=$((LAST_NUM + 1))
TASK_ID=$(printf "TASK-%03d" $NEXT_NUM)

STORY_FILE="$FEATURE_DIR/$TASK_ID.md"

cat > "$STORY_FILE" << EOF
# [$TASK_ID] $TITLE

## User Story
**As a** [user type]
**I want** [action/capability]
**So that** [benefit/value]

## Description
[2-4 sentences explaining the context, what needs to be built, and why it matters.]

## Acceptance Criteria

### Scenario 1: Happy path
**Given** [initial context/state]
**When** [action taken]
**Then** [expected outcome]
**And** [additional outcome if needed]

### Scenario 2: Alternative path
**Given** [context]
**When** [action]
**Then** [outcome]

### Scenario 3: Error handling
**Given** [context]
**When** [invalid action or error condition]
**Then** [error handling behavior]

## Technical Notes
- **Components**: 
  - Use existing: [check app-map.md]
  - Create new: [add to app-map after]
- **API**: [endpoints if any]
- **State**: [state management notes]
- **Constraints**: [technical limitations]

## Test Strategy
- [ ] Unit: [what to test]
- [ ] Integration: [what to test]
- [ ] E2E: [user flow to verify]

## Dependencies
- None

## Complexity
[Low / Medium / High] - [justification]

## Out of Scope
- [What this does NOT include]
EOF

echo -e "${GREEN}âœ“ Created story: $TASK_ID${NC}"
echo -e "  ${CYAN}$STORY_FILE${NC}"
echo ""
echo "Title: $TITLE"
echo "Feature: $FEATURE"
echo ""
echo "Next steps:"
echo "  1. Fill in the story details"
echo "  2. Check app-map.md for existing components"
echo "  3. Add to ready.json when ready to implement"

#!/bin/bash

# Wogi Flow - Project Onboarding
# Analyzes existing projects and sets up workflow with context

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(pwd)"
WORKFLOW_DIR=".workflow"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Collected data
PROJECT_NAME=""
PROJECT_DESCRIPTION=""
DETECTED_FRAMEWORK=""
DETECTED_LANGUAGE=""
DETECTED_COMPONENTS=()
PRD_CONTENT=""
ADDITIONAL_DOCS=""

print_header() {
    clear
    echo -e "${CYAN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë          üîç Wogi Flow - Project Onboarding üîç                 ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïë     Analyze existing project & set up workflow                ‚ïë"
    echo "‚ïë                                                               ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    echo ""
}

# ============================================================
# DETECTION FUNCTIONS
# ============================================================

detect_package_manager() {
    if [ -f "package-lock.json" ]; then
        echo "npm"
    elif [ -f "yarn.lock" ]; then
        echo "yarn"
    elif [ -f "pnpm-lock.yaml" ]; then
        echo "pnpm"
    elif [ -f "requirements.txt" ] || [ -f "Pipfile" ]; then
        echo "pip"
    elif [ -f "go.mod" ]; then
        echo "go"
    elif [ -f "Cargo.toml" ]; then
        echo "cargo"
    else
        echo "unknown"
    fi
}

detect_framework() {
    local framework="unknown"
    
    # Check package.json for JS/TS frameworks
    if [ -f "package.json" ]; then
        if grep -q '"next"' package.json 2>/dev/null; then
            framework="Next.js"
        elif grep -q '"@nestjs/core"' package.json 2>/dev/null; then
            framework="NestJS"
        elif grep -q '"react"' package.json 2>/dev/null; then
            if grep -q '"react-native"' package.json 2>/dev/null; then
                framework="React Native"
            else
                framework="React"
            fi
        elif grep -q '"vue"' package.json 2>/dev/null; then
            framework="Vue"
        elif grep -q '"@angular/core"' package.json 2>/dev/null; then
            framework="Angular"
        elif grep -q '"express"' package.json 2>/dev/null; then
            framework="Express"
        elif grep -q '"fastify"' package.json 2>/dev/null; then
            framework="Fastify"
        fi
    fi
    
    # Check for Python frameworks
    if [ -f "requirements.txt" ]; then
        if grep -qi "fastapi" requirements.txt 2>/dev/null; then
            framework="FastAPI"
        elif grep -qi "django" requirements.txt 2>/dev/null; then
            framework="Django"
        elif grep -qi "flask" requirements.txt 2>/dev/null; then
            framework="Flask"
        fi
    fi
    
    # Check for specific files
    if [ -f "next.config.js" ] || [ -f "next.config.mjs" ]; then
        framework="Next.js"
    elif [ -f "nest-cli.json" ]; then
        framework="NestJS"
    elif [ -f "angular.json" ]; then
        framework="Angular"
    elif [ -f "nuxt.config.js" ] || [ -f "nuxt.config.ts" ]; then
        framework="Nuxt"
    fi
    
    echo "$framework"
}

detect_language() {
    if [ -f "tsconfig.json" ]; then
        echo "TypeScript"
    elif [ -f "package.json" ]; then
        echo "JavaScript"
    elif [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
        echo "Python"
    elif [ -f "go.mod" ]; then
        echo "Go"
    elif [ -f "Cargo.toml" ]; then
        echo "Rust"
    elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
        echo "Java"
    else
        echo "unknown"
    fi
}

detect_database() {
    local db=""
    
    if [ -f "package.json" ]; then
        if grep -q '"typeorm"' package.json 2>/dev/null; then
            db="TypeORM"
        elif grep -q '"prisma"' package.json 2>/dev/null; then
            db="Prisma"
        elif grep -q '"mongoose"' package.json 2>/dev/null; then
            db="MongoDB (Mongoose)"
        elif grep -q '"sequelize"' package.json 2>/dev/null; then
            db="Sequelize"
        elif grep -q '"knex"' package.json 2>/dev/null; then
            db="Knex"
        fi
    fi
    
    if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
        if grep -q "postgres" docker-compose.yml 2>/dev/null; then
            db="${db:+$db + }PostgreSQL"
        elif grep -q "mysql" docker-compose.yml 2>/dev/null; then
            db="${db:+$db + }MySQL"
        elif grep -q "mongo" docker-compose.yml 2>/dev/null; then
            db="${db:+$db + }MongoDB"
        elif grep -q "redis" docker-compose.yml 2>/dev/null; then
            db="${db:+$db + }Redis"
        fi
    fi
    
    echo "${db:-unknown}"
}

scan_components() {
    echo -e "${CYAN}Scanning for components...${NC}"
    
    local components=()
    
    # React/Vue components
    if [ -d "src/components" ]; then
        while IFS= read -r -d '' file; do
            local name=$(basename "$file" | sed 's/\.\(tsx\|jsx\|vue\|ts\|js\)$//')
            if [[ "$name" != "index" ]]; then
                components+=("$name|$file|component")
            fi
        done < <(find src/components -type f \( -name "*.tsx" -o -name "*.jsx" -o -name "*.vue" \) -print0 2>/dev/null)
    fi
    
    # Pages/Routes
    if [ -d "src/pages" ] || [ -d "pages" ] || [ -d "app" ]; then
        local pages_dir=""
        [ -d "src/pages" ] && pages_dir="src/pages"
        [ -d "pages" ] && pages_dir="pages"
        [ -d "app" ] && pages_dir="app"
        
        if [ -n "$pages_dir" ]; then
            while IFS= read -r -d '' file; do
                local name=$(basename "$file" | sed 's/\.\(tsx\|jsx\|vue\|ts\|js\)$//')
                if [[ "$name" != "index" && "$name" != "_app" && "$name" != "_document" && "$name" != "layout" ]]; then
                    components+=("$name|$file|page")
                fi
            done < <(find "$pages_dir" -type f \( -name "*.tsx" -o -name "*.jsx" -o -name "*.vue" \) -print0 2>/dev/null)
        fi
    fi
    
    # NestJS modules
    if [ -d "src" ]; then
        while IFS= read -r -d '' file; do
            local name=$(basename "$(dirname "$file")")
            components+=("$name|$file|module")
        done < <(find src -name "*.module.ts" -print0 2>/dev/null)
    fi
    
    # Store globally
    DETECTED_COMPONENTS=("${components[@]}")
    
    echo -e "${GREEN}‚úì${NC} Found ${#components[@]} components/modules"
}

scan_api_routes() {
    echo -e "${CYAN}Scanning for API routes...${NC}"
    
    local routes=()
    
    # Next.js API routes
    if [ -d "pages/api" ] || [ -d "src/pages/api" ] || [ -d "app/api" ]; then
        local api_dir=""
        [ -d "pages/api" ] && api_dir="pages/api"
        [ -d "src/pages/api" ] && api_dir="src/pages/api"
        [ -d "app/api" ] && api_dir="app/api"
        
        if [ -n "$api_dir" ]; then
            routes=($(find "$api_dir" -type f \( -name "*.ts" -o -name "*.js" \) 2>/dev/null | head -20))
        fi
    fi
    
    # NestJS controllers
    if [ -d "src" ]; then
        routes+=($(find src -name "*.controller.ts" 2>/dev/null | head -20))
    fi
    
    # Express routes
    if [ -d "routes" ] || [ -d "src/routes" ]; then
        local routes_dir=""
        [ -d "routes" ] && routes_dir="routes"
        [ -d "src/routes" ] && routes_dir="src/routes"
        
        if [ -n "$routes_dir" ]; then
            routes+=($(find "$routes_dir" -type f \( -name "*.ts" -o -name "*.js" \) 2>/dev/null | head -20))
        fi
    fi
    
    echo -e "${GREEN}‚úì${NC} Found ${#routes[@]} API routes/controllers"
}

count_lines_of_code() {
    local total=0
    
    if command -v cloc &> /dev/null; then
        total=$(cloc . --quiet --csv 2>/dev/null | tail -1 | cut -d',' -f5)
    else
        # Fallback: count manually
        total=$(find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.py" -o -name "*.go" -o -name "*.rs" \) \
            -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/dist/*" -not -path "*/build/*" \
            -exec cat {} \; 2>/dev/null | wc -l)
    fi
    
    echo "$total"
}

# ============================================================
# INTERVIEW FUNCTIONS
# ============================================================

ask_project_basics() {
    echo -e "${BOLD}1. Project Basics${NC}"
    echo ""
    
    # Try to detect name
    local default_name=""
    if [ -f "package.json" ]; then
        default_name=$(python3 -c "import json; print(json.load(open('package.json')).get('name', ''))" 2>/dev/null || echo "")
    fi
    [ -z "$default_name" ] && default_name=$(basename "$(pwd)")
    
    read -p "   Project name [$default_name]: " PROJECT_NAME
    PROJECT_NAME="${PROJECT_NAME:-$default_name}"
    
    echo ""
    echo "   Brief description (1-2 sentences):"
    read -p "   > " PROJECT_DESCRIPTION
    echo ""
}

ask_for_prd() {
    echo -e "${BOLD}2. Project Documentation${NC}"
    echo ""
    echo "   Do you have any of these documents?"
    echo "   - PRD (Product Requirements Document)"
    echo "   - README with project overview"
    echo "   - Technical spec"
    echo "   - Architecture doc"
    echo ""
    
    # Check for common doc files
    local found_docs=()
    [ -f "PRD.md" ] && found_docs+=("PRD.md")
    [ -f "prd.md" ] && found_docs+=("prd.md")
    [ -f "docs/PRD.md" ] && found_docs+=("docs/PRD.md")
    [ -f "README.md" ] && found_docs+=("README.md")
    [ -f "ARCHITECTURE.md" ] && found_docs+=("ARCHITECTURE.md")
    [ -f "docs/architecture.md" ] && found_docs+=("docs/architecture.md")
    [ -f "TECHNICAL.md" ] && found_docs+=("TECHNICAL.md")
    [ -f "docs/technical-spec.md" ] && found_docs+=("docs/technical-spec.md")
    
    if [ ${#found_docs[@]} -gt 0 ]; then
        echo -e "   ${GREEN}Found these docs:${NC}"
        for doc in "${found_docs[@]}"; do
            echo "   - $doc"
        done
        echo ""
        read -p "   Should I read these? (y/n) [y]: " read_docs
        if [[ "${read_docs:-y}" =~ ^[Yy]$ ]]; then
            for doc in "${found_docs[@]}"; do
                echo -e "   ${DIM}Reading $doc...${NC}"
                PRD_CONTENT+="
--- $doc ---
$(head -500 "$doc" 2>/dev/null)
"
            done
            echo -e "   ${GREEN}‚úì${NC} Documents loaded"
        fi
    fi
    
    echo ""
    read -p "   Path to additional doc (or press Enter to skip): " additional_doc
    if [ -n "$additional_doc" ] && [ -f "$additional_doc" ]; then
        ADDITIONAL_DOCS=$(head -500 "$additional_doc" 2>/dev/null)
        echo -e "   ${GREEN}‚úì${NC} Loaded $additional_doc"
    fi
    
    echo ""
    echo "   Want to paste PRD/description directly? (y/n) [n]:"
    read -p "   " paste_prd
    if [[ "$paste_prd" =~ ^[Yy]$ ]]; then
        echo "   Paste your content (end with a line containing just 'END'):"
        local pasted=""
        while IFS= read -r line; do
            [[ "$line" == "END" ]] && break
            pasted+="$line"$'\n'
        done
        PRD_CONTENT+="
--- Pasted Content ---
$pasted
"
        echo -e "   ${GREEN}‚úì${NC} Content captured"
    fi
    echo ""
}

ask_current_state() {
    echo -e "${BOLD}3. Current State${NC}"
    echo ""
    
    echo "   What's the current state of the project?"
    echo "   (a) New/early development"
    echo "   (b) MVP / working prototype"
    echo "   (c) Production with active users"
    echo "   (d) Maintenance mode"
    echo ""
    read -p "   Choice [b]: " state_choice
    
    case "$state_choice" in
        a) PROJECT_STATE="early" ;;
        c) PROJECT_STATE="production" ;;
        d) PROJECT_STATE="maintenance" ;;
        *) PROJECT_STATE="mvp" ;;
    esac
    
    echo ""
    echo "   What are you trying to accomplish with AI assistance?"
    echo "   (Select all that apply, comma-separated)"
    echo "   1. Add new features"
    echo "   2. Fix bugs"
    echo "   3. Refactor/improve code quality"
    echo "   4. Add tests"
    echo "   5. Documentation"
    echo "   6. Performance optimization"
    echo "   7. Security improvements"
    echo ""
    read -p "   Choices [1,2]: " goals_input
    GOALS="${goals_input:-1,2}"
    echo ""
}

ask_known_issues() {
    echo -e "${BOLD}4. Known Issues & Tech Debt${NC}"
    echo ""
    echo "   Any known issues, bugs, or tech debt? (one per line, 'done' to finish)"
    echo ""
    
    KNOWN_ISSUES=""
    while true; do
        read -p "   - " issue
        [[ "$issue" == "done" || -z "$issue" ]] && break
        KNOWN_ISSUES+="- $issue"$'\n'
    done
    echo ""
}

ask_coding_preferences() {
    echo -e "${BOLD}5. Coding Preferences${NC}"
    echo ""
    
    echo "   Any specific coding patterns or conventions?"
    echo "   (e.g., 'use functional components', 'services should be thin')"
    echo "   (one per line, 'done' to finish)"
    echo ""
    
    CODING_PATTERNS=""
    while true; do
        read -p "   - " pattern
        [[ "$pattern" == "done" || -z "$pattern" ]] && break
        CODING_PATTERNS+="- $pattern"$'\n'
    done
    echo ""
}

# ============================================================
# GENERATION FUNCTIONS
# ============================================================

generate_project_spec() {
    echo -e "${CYAN}Generating project specification...${NC}"
    
    cat > "$WORKFLOW_DIR/specs/project.md" << EOF
# Project Specification: $PROJECT_NAME

## Overview

$PROJECT_DESCRIPTION

## Tech Stack

| Component | Technology |
|-----------|------------|
| Language | $DETECTED_LANGUAGE |
| Framework | $DETECTED_FRAMEWORK |
| Database | $(detect_database) |
| Package Manager | $(detect_package_manager) |

## Project State

- **Current Phase**: $PROJECT_STATE
- **Lines of Code**: ~$(count_lines_of_code)
- **Components/Modules**: ${#DETECTED_COMPONENTS[@]}

## Goals

$(echo "$GOALS" | tr ',' '\n' | while read g; do
    case "$g" in
        1) echo "- Add new features" ;;
        2) echo "- Fix bugs" ;;
        3) echo "- Refactor/improve code quality" ;;
        4) echo "- Add tests" ;;
        5) echo "- Documentation" ;;
        6) echo "- Performance optimization" ;;
        7) echo "- Security improvements" ;;
    esac
done)

## Known Issues / Tech Debt

$KNOWN_ISSUES

## Coding Conventions

$CODING_PATTERNS

---

## Source Documents

${PRD_CONTENT:+PRD and documentation have been loaded. See below for key excerpts.}

${PRD_CONTENT:-No PRD or documentation provided.}

${ADDITIONAL_DOCS:+
### Additional Documentation

$ADDITIONAL_DOCS
}
EOF
    
    echo -e "${GREEN}‚úì${NC} Created project.md"
}

generate_app_map() {
    echo -e "${CYAN}Generating app map...${NC}"
    
    cat > "$WORKFLOW_DIR/state/app-map.md" << 'EOF'
# App Map - Component Registry

> Auto-generated during project onboarding. Review and update as needed.

EOF

    # Add pages/screens
    echo "## Screens / Pages" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "| Screen | Route | Description |" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "|--------|-------|-------------|" >> "$WORKFLOW_DIR/state/app-map.md"
    
    local has_pages=false
    for comp in "${DETECTED_COMPONENTS[@]}"; do
        IFS='|' read -r name path type <<< "$comp"
        if [[ "$type" == "page" ]]; then
            local route=$(echo "$path" | sed 's|.*pages/||' | sed 's|\.tsx$||' | sed 's|\.jsx$||' | sed 's|/index$||')
            echo "| $name | /$route | - |" >> "$WORKFLOW_DIR/state/app-map.md"
            has_pages=true
        fi
    done
    
    if [ "$has_pages" = false ]; then
        echo "| - | - | - |" >> "$WORKFLOW_DIR/state/app-map.md"
    fi
    
    # Add components
    echo "" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "## Components" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "| Component | Path | Type |" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "|-----------|------|------|" >> "$WORKFLOW_DIR/state/app-map.md"
    
    local has_components=false
    for comp in "${DETECTED_COMPONENTS[@]}"; do
        IFS='|' read -r name path type <<< "$comp"
        if [[ "$type" == "component" ]]; then
            echo "| $name | $path | UI |" >> "$WORKFLOW_DIR/state/app-map.md"
            has_components=true
        fi
    done
    
    if [ "$has_components" = false ]; then
        echo "| - | - | - |" >> "$WORKFLOW_DIR/state/app-map.md"
    fi
    
    # Add modules (NestJS)
    echo "" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "## Modules / Services" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "| Module | Path | Description |" >> "$WORKFLOW_DIR/state/app-map.md"
    echo "|--------|------|-------------|" >> "$WORKFLOW_DIR/state/app-map.md"
    
    local has_modules=false
    for comp in "${DETECTED_COMPONENTS[@]}"; do
        IFS='|' read -r name path type <<< "$comp"
        if [[ "$type" == "module" ]]; then
            echo "| $name | $path | - |" >> "$WORKFLOW_DIR/state/app-map.md"
            has_modules=true
        fi
    done
    
    if [ "$has_modules" = false ]; then
        echo "| - | - | - |" >> "$WORKFLOW_DIR/state/app-map.md"
    fi
    
    echo -e "${GREEN}‚úì${NC} Created app-map.md with ${#DETECTED_COMPONENTS[@]} entries"
}

generate_decisions() {
    echo -e "${CYAN}Generating decisions.md...${NC}"
    
    cat > "$WORKFLOW_DIR/state/decisions.md" << EOF
# Project Decisions

> Coding patterns, architectural decisions, and conventions for $PROJECT_NAME.

## Tech Stack

- **Language**: $DETECTED_LANGUAGE
- **Framework**: $DETECTED_FRAMEWORK
- **Database**: $(detect_database)

## Conventions

$CODING_PATTERNS

## Patterns

<!-- Add patterns discovered during development -->

## Architecture Notes

<!-- Add architectural decisions here -->

EOF
    
    echo -e "${GREEN}‚úì${NC} Created decisions.md"
}

generate_initial_tasks() {
    echo -e "${CYAN}Generating initial tasks...${NC}"
    
    # Parse known issues into tasks
    if [ -n "$KNOWN_ISSUES" ]; then
        local task_num=1
        mkdir -p "$WORKFLOW_DIR/changes/onboarding"
        
        cat > "$WORKFLOW_DIR/changes/onboarding/tasks.json" << EOF
{
  "feature": "onboarding-tasks",
  "created": "$(date -Iseconds)",
  "tasks": [
EOF
        
        local first=true
        while IFS= read -r issue; do
            if [ -n "$issue" ] && [[ "$issue" != "- " ]]; then
                local title=$(echo "$issue" | sed 's/^- //')
                
                [ "$first" = false ] && echo "," >> "$WORKFLOW_DIR/changes/onboarding/tasks.json"
                first=false
                
                cat >> "$WORKFLOW_DIR/changes/onboarding/tasks.json" << EOF
    {
      "id": "TASK-$(printf '%03d' $task_num)",
      "title": "$title",
      "type": "bugfix",
      "status": "pending",
      "priority": "medium",
      "phase": null,
      "dependencies": [],
      "testSteps": [],
      "implemented": false,
      "tested": false,
      "commitHash": null
    }
EOF
                ((task_num++))
            fi
        done <<< "$KNOWN_ISSUES"
        
        echo "
  ]
}" >> "$WORKFLOW_DIR/changes/onboarding/tasks.json"
        
        echo -e "${GREEN}‚úì${NC} Created $((task_num-1)) initial tasks from known issues"
    fi
}

suggest_skills() {
    echo -e "${CYAN}Suggesting skills...${NC}"
    
    local suggested=""
    
    case "$DETECTED_FRAMEWORK" in
        "NestJS")
            suggested="nestjs"
            ;;
        "React"|"Next.js"|"React Native")
            suggested="react"
            ;;
        "FastAPI"|"Django"|"Flask")
            suggested="python"
            ;;
    esac
    
    if [ -n "$suggested" ]; then
        echo -e "${GREEN}‚úì${NC} Recommended skill: $suggested"
        
        # Update config
        python3 << EOF
import json
try:
    with open('$WORKFLOW_DIR/config.json', 'r') as f:
        config = json.load(f)
    
    if '$suggested' not in config.get('skills', {}).get('installed', []):
        config.setdefault('skills', {}).setdefault('installed', []).append('$suggested')
    
    with open('$WORKFLOW_DIR/config.json', 'w') as f:
        json.dump(config, f, indent=2)
except Exception as e:
    print(f"Note: Could not update config: {e}")
EOF
    fi
}

# ============================================================
# MAIN
# ============================================================

print_summary() {
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë           ‚úÖ Project Onboarding Complete!                     ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${BOLD}Project: $PROJECT_NAME${NC}"
    echo ""
    echo "Detected:"
    echo "  ‚Ä¢ Language:   $DETECTED_LANGUAGE"
    echo "  ‚Ä¢ Framework:  $DETECTED_FRAMEWORK"
    echo "  ‚Ä¢ Database:   $(detect_database)"
    echo "  ‚Ä¢ Components: ${#DETECTED_COMPONENTS[@]}"
    echo ""
    echo "Generated:"
    echo "  ‚Ä¢ .workflow/specs/project.md     - Project specification"
    echo "  ‚Ä¢ .workflow/state/app-map.md     - Component registry"
    echo "  ‚Ä¢ .workflow/state/decisions.md   - Coding patterns"
    [ -n "$KNOWN_ISSUES" ] && echo "  ‚Ä¢ .workflow/changes/onboarding/  - Initial tasks"
    echo ""
    echo -e "${BOLD}Next steps:${NC}"
    echo ""
    echo "  1. Review generated files and fill in details"
    echo "  2. Run /wogi-health to verify setup"
    echo "  3. Run /wogi-ready to see tasks"
    echo "  4. Start working: /wogi-start TASK-001"
    echo ""
    echo -e "${YELLOW}Tip:${NC} The AI now has context about your project!"
    echo "     Ask it to analyze code, suggest improvements, or create new features."
    echo ""
}

main() {
    print_header
    
    # Check if already onboarded
    if [ -f "$WORKFLOW_DIR/specs/project.md" ] && grep -q "Tech Stack" "$WORKFLOW_DIR/specs/project.md" 2>/dev/null; then
        echo -e "${YELLOW}‚ö† This project appears to be already onboarded.${NC}"
        echo ""
        read -p "Re-run onboarding? (y/n): " rerun
        if [[ ! "$rerun" =~ ^[Yy]$ ]]; then
            echo "Onboarding cancelled."
            exit 0
        fi
        echo ""
    fi
    
    # Ensure workflow exists
    if [ ! -d "$WORKFLOW_DIR" ]; then
        echo -e "${YELLOW}Workflow not initialized. Running install first...${NC}"
        "$SCRIPT_DIR/flow-install" --quick "$(basename "$(pwd)")"
        echo ""
    fi
    
    # Detection phase
    echo -e "${BOLD}‚îÅ‚îÅ‚îÅ Analyzing Project ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    
    DETECTED_LANGUAGE=$(detect_language)
    DETECTED_FRAMEWORK=$(detect_framework)
    
    echo -e "  Language:  ${GREEN}$DETECTED_LANGUAGE${NC}"
    echo -e "  Framework: ${GREEN}$DETECTED_FRAMEWORK${NC}"
    echo -e "  Database:  ${GREEN}$(detect_database)${NC}"
    echo ""
    
    scan_components
    scan_api_routes
    
    echo ""
    echo -e "${BOLD}‚îÅ‚îÅ‚îÅ Project Interview ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    
    ask_project_basics
    ask_for_prd
    ask_current_state
    ask_known_issues
    ask_coding_preferences
    
    echo -e "${BOLD}‚îÅ‚îÅ‚îÅ Generating Workflow Files ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    
    generate_project_spec
    generate_app_map
    generate_decisions
    generate_initial_tasks
    suggest_skills
    
    # Update config with project name
    python3 << EOF
import json
try:
    with open('$WORKFLOW_DIR/config.json', 'r') as f:
        config = json.load(f)
    config['projectName'] = '$PROJECT_NAME'
    with open('$WORKFLOW_DIR/config.json', 'w') as f:
        json.dump(config, f, indent=2)
except:
    pass
EOF
    
    print_summary
}

# Handle --help
if [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
    echo "Wogi Flow - Project Onboarding"
    echo ""
    echo "Analyzes an existing project and sets up the workflow with full context."
    echo ""
    echo "Usage: flow onboard"
    echo ""
    echo "This will:"
    echo "  1. Detect your tech stack (language, framework, database)"
    echo "  2. Scan for components, pages, modules"
    echo "  3. Ask about your project (PRD, goals, issues)"
    echo "  4. Generate project.md, app-map.md, decisions.md"
    echo "  5. Create initial tasks from known issues"
    echo "  6. Suggest relevant skills to install"
    exit 0
fi

main "$@"

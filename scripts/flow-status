#!/bin/bash

# Wogi Flow - Project Status Overview

set -e

WORKFLOW_DIR=".workflow"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${CYAN}═══════════════════════════════════════${NC}"
echo -e "${CYAN}        PROJECT STATUS${NC}"
echo -e "${CYAN}═══════════════════════════════════════${NC}"
echo ""

# Task counts
if [ -f "$WORKFLOW_DIR/state/ready.json" ]; then
    echo -e "${CYAN}Tasks${NC}"
    python3 << EOF
import json
with open('$WORKFLOW_DIR/state/ready.json') as f:
    data = json.load(f)
ready = len(data.get('ready', []))
in_prog = len(data.get('inProgress', []))
blocked = len(data.get('blocked', []))
done = len(data.get('recentlyCompleted', []))
print(f"  Ready: {ready}")
print(f"  In Progress: {in_prog}")
print(f"  Blocked: {blocked}")
print(f"  Recently Done: {done}")
EOF
    echo ""
fi

# Features
if [ -d "$WORKFLOW_DIR/changes" ]; then
    feature_count=$(find "$WORKFLOW_DIR/changes" -maxdepth 1 -type d | wc -l)
    feature_count=$((feature_count - 1))
    echo -e "${CYAN}Features${NC}"
    echo "  Active: $feature_count"
    if [ $feature_count -gt 0 ]; then
        for dir in "$WORKFLOW_DIR/changes"/*/; do
            if [ -d "$dir" ]; then
                name=$(basename "$dir")
                echo "    • $name"
            fi
        done
    fi
    echo ""
fi

# Bugs
if [ -d "$WORKFLOW_DIR/bugs" ]; then
    bug_count=$(ls "$WORKFLOW_DIR/bugs"/*.md 2>/dev/null | wc -l || echo 0)
    echo -e "${CYAN}Bugs${NC}"
    echo "  Open: $bug_count"
    echo ""
fi

# Components (from app-map)
if [ -f "$WORKFLOW_DIR/state/app-map.md" ]; then
    component_count=$(grep -c "^|" "$WORKFLOW_DIR/state/app-map.md" 2>/dev/null || echo 0)
    component_count=$((component_count - 6)) # Subtract headers
    if [ $component_count -lt 0 ]; then component_count=0; fi
    echo -e "${CYAN}Components${NC}"
    echo "  Mapped: $component_count"
    echo ""
fi

# Request log entries
if [ -f "$WORKFLOW_DIR/state/request-log.md" ]; then
    entry_count=$(grep -c "^### R-" "$WORKFLOW_DIR/state/request-log.md" 2>/dev/null || echo 0)
    echo -e "${CYAN}Request Log${NC}"
    echo "  Entries: $entry_count"
    echo ""
fi

# Git status
if [ -d ".git" ]; then
    echo -e "${CYAN}Git${NC}"
    branch=$(git branch --show-current 2>/dev/null || echo "unknown")
    uncommitted=$(git status --porcelain 2>/dev/null | wc -l)
    echo "  Branch: $branch"
    echo "  Uncommitted: $uncommitted files"
    echo ""
fi

# Config summary
if [ -f "$WORKFLOW_DIR/config.json" ]; then
    echo -e "${CYAN}Config${NC}"
    python3 << EOF
import json
with open('$WORKFLOW_DIR/config.json') as f:
    config = json.load(f)
steps = config.get('mandatorySteps', {})
after_task = steps.get('afterTask', [])
if after_task:
    print(f"  After task: {', '.join(after_task)}")
else:
    print("  After task: (none)")
EOF
fi

echo ""
echo -e "${CYAN}═══════════════════════════════════════${NC}"

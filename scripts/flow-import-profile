#!/bin/bash

# Wogi Flow - Import Profile
# Import workflow configuration from team

set -e

WORKFLOW_DIR=".workflow"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

show_help() {
    echo "Import Workflow Profile"
    echo ""
    echo "Usage: flow import-profile <profile.zip> [options]"
    echo ""
    echo "Options:"
    echo "  --backup       Create backup of current config before importing"
    echo "  --dry-run      Show what would be imported without making changes"
    echo "  --force        Overwrite without confirmation"
    echo ""
    echo "Examples:"
    echo "  flow import-profile team-frontend.zip"
    echo "  flow import-profile team-frontend.zip --backup"
}

if [ -z "$1" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

PROFILE_FILE="$1"
shift

# Parse options
BACKUP=false
DRY_RUN=false
FORCE=false

while [ $# -gt 0 ]; do
    case "$1" in
        --backup)
            BACKUP=true
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        --force)
            FORCE=true
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
    shift
done

# Check file exists
if [ ! -f "$PROFILE_FILE" ]; then
    echo -e "${RED}Error: Profile file not found: $PROFILE_FILE${NC}"
    exit 1
fi

# Create temp directory
TEMP_DIR=$(mktemp -d)

echo -e "${CYAN}Importing profile: $PROFILE_FILE${NC}"
echo ""

# Extract profile
unzip -q "$PROFILE_FILE" -d "$TEMP_DIR"

# Find the profile directory (first directory in zip)
PROFILE_DIR=$(find "$TEMP_DIR" -mindepth 1 -maxdepth 1 -type d | head -1)

if [ -z "$PROFILE_DIR" ]; then
    echo -e "${RED}Error: Invalid profile format${NC}"
    rm -rf "$TEMP_DIR"
    exit 1
fi

# Show profile info
if [ -f "$PROFILE_DIR/PROFILE.md" ]; then
    echo -e "${CYAN}Profile Info:${NC}"
    head -10 "$PROFILE_DIR/PROFILE.md"
    echo "..."
    echo ""
fi

# Show what will be imported
echo -e "${CYAN}Files to import:${NC}"

files_to_import=()

if [ -f "$PROFILE_DIR/CLAUDE.md" ]; then
    echo -e "  ${GREEN}→${NC} CLAUDE.md"
    files_to_import+=("CLAUDE.md")
fi

if [ -d "$PROFILE_DIR/agents" ]; then
    agent_count=$(ls "$PROFILE_DIR/agents"/*.md 2>/dev/null | wc -l)
    echo -e "  ${GREEN}→${NC} agents/ ($agent_count files)"
    files_to_import+=("agents")
fi

if [ -f "$PROFILE_DIR/.workflow/config.json" ]; then
    echo -e "  ${GREEN}→${NC} .workflow/config.json"
    files_to_import+=("config.json")
fi

if [ -f "$PROFILE_DIR/.workflow/state/decisions.md" ]; then
    echo -e "  ${YELLOW}→${NC} .workflow/state/decisions.md (will merge)"
    files_to_import+=("decisions.md")
fi

if [ -f "$PROFILE_DIR/.workflow/state/app-map.md" ]; then
    echo -e "  ${YELLOW}→${NC} .workflow/state/app-map.md (optional)"
    files_to_import+=("app-map.md")
fi

echo ""

# Dry run stops here
if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}Dry run - no changes made${NC}"
    rm -rf "$TEMP_DIR"
    exit 0
fi

# Confirm unless forced
if [ "$FORCE" != true ]; then
    read -p "Import these files? This will overwrite existing files. (y/N) " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        echo "Cancelled"
        rm -rf "$TEMP_DIR"
        exit 0
    fi
fi

# Create backup if requested
if [ "$BACKUP" = true ]; then
    BACKUP_DIR="wogi-backup-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    
    [ -f "CLAUDE.md" ] && cp "CLAUDE.md" "$BACKUP_DIR/"
    [ -d "agents" ] && cp -r "agents" "$BACKUP_DIR/"
    [ -f "$WORKFLOW_DIR/config.json" ] && cp "$WORKFLOW_DIR/config.json" "$BACKUP_DIR/"
    
    echo -e "${GREEN}✓${NC} Backup created: $BACKUP_DIR"
fi

# Import files
echo ""
echo -e "${CYAN}Importing...${NC}"

# CLAUDE.md
if [ -f "$PROFILE_DIR/CLAUDE.md" ]; then
    cp "$PROFILE_DIR/CLAUDE.md" ./
    echo -e "  ${GREEN}✓${NC} CLAUDE.md"
fi

# agents/
if [ -d "$PROFILE_DIR/agents" ]; then
    mkdir -p agents
    cp "$PROFILE_DIR/agents"/*.md agents/
    echo -e "  ${GREEN}✓${NC} agents/"
fi

# config.json
if [ -f "$PROFILE_DIR/.workflow/config.json" ]; then
    mkdir -p "$WORKFLOW_DIR"
    cp "$PROFILE_DIR/.workflow/config.json" "$WORKFLOW_DIR/"
    echo -e "  ${GREEN}✓${NC} config.json"
fi

# decisions.md (append if exists)
if [ -f "$PROFILE_DIR/.workflow/state/decisions.md" ]; then
    mkdir -p "$WORKFLOW_DIR/state"
    if [ -f "$WORKFLOW_DIR/state/decisions.md" ]; then
        echo "" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "---" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "## Imported from profile: $(basename "$PROFILE_FILE")" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "Imported: $(date)" >> "$WORKFLOW_DIR/state/decisions.md"
        cat "$PROFILE_DIR/.workflow/state/decisions.md" >> "$WORKFLOW_DIR/state/decisions.md"
        echo -e "  ${GREEN}✓${NC} decisions.md (merged)"
    else
        cp "$PROFILE_DIR/.workflow/state/decisions.md" "$WORKFLOW_DIR/state/"
        echo -e "  ${GREEN}✓${NC} decisions.md"
    fi
fi

# Cleanup
rm -rf "$TEMP_DIR"

echo ""
echo -e "${GREEN}✓ Profile imported successfully!${NC}"
echo ""
echo "Restart Claude CLI to apply changes."

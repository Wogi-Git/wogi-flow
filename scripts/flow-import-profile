#!/bin/bash

# Wogi Flow - Import Profile
# Import workflow configuration from team
# v2.1: Enhanced with rules, learnings, and templates support

set -e

WORKFLOW_DIR=".workflow"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

show_help() {
    echo "Import Workflow Profile"
    echo ""
    echo "Usage: flow import-profile <profile.zip> [options]"
    echo ""
    echo "Options:"
    echo "  --backup           Create backup of current config before importing"
    echo "  --dry-run          Show what would be imported without making changes"
    echo "  --force            Overwrite without confirmation"
    echo "  --skip-learnings   Don't import learnings (feedback-patterns, skill learnings)"
    echo "  --skip-rules       Don't import rules (.claude/rules/)"
    echo "  --skip-templates   Don't import templates"
    echo ""
    echo "Examples:"
    echo "  flow import-profile team-frontend.zip"
    echo "  flow import-profile team-frontend.zip --backup"
    echo "  flow import-profile team-frontend.zip --skip-learnings"
}

if [ -z "$1" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

PROFILE_FILE="$1"
shift

# Parse options
BACKUP=false
DRY_RUN=false
FORCE=false
SKIP_LEARNINGS=false
SKIP_RULES=false
SKIP_TEMPLATES=false

while [ $# -gt 0 ]; do
    case "$1" in
        --backup)
            BACKUP=true
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        --force)
            FORCE=true
            ;;
        --skip-learnings)
            SKIP_LEARNINGS=true
            ;;
        --skip-rules)
            SKIP_RULES=true
            ;;
        --skip-templates)
            SKIP_TEMPLATES=true
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
    shift
done

# Check file exists
if [ ! -f "$PROFILE_FILE" ]; then
    echo -e "${RED}Error: Profile file not found: $PROFILE_FILE${NC}"
    exit 1
fi

# Create temp directory
TEMP_DIR=$(mktemp -d)

echo -e "${CYAN}╔══════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║  Importing Profile                                        ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Extract profile
unzip -q "$PROFILE_FILE" -d "$TEMP_DIR"

# Find the profile directory (first directory in zip)
PROFILE_DIR=$(find "$TEMP_DIR" -mindepth 1 -maxdepth 1 -type d | head -1)

if [ -z "$PROFILE_DIR" ]; then
    echo -e "${RED}Error: Invalid profile format${NC}"
    rm -rf "$TEMP_DIR"
    exit 1
fi

# Show profile info
if [ -f "$PROFILE_DIR/PROFILE.md" ]; then
    echo -e "${CYAN}Profile Info:${NC}"
    head -15 "$PROFILE_DIR/PROFILE.md" | sed 's/^/  /'
    echo "  ..."
    echo ""
fi

# ==========================================
# Analyze what will be imported
# ==========================================
echo -e "${YELLOW}Files to import:${NC}"
echo ""

# Track counts
CORE_COUNT=0
RULES_COUNT=0
LEARNINGS_COUNT=0
TEMPLATES_COUNT=0

# CORE FILES
echo -e "${DIM}Core:${NC}"

if [ -f "$PROFILE_DIR/CLAUDE.md" ]; then
    echo -e "  ${GREEN}→${NC} CLAUDE.md"
    CORE_COUNT=$((CORE_COUNT + 1))
fi

if [ -d "$PROFILE_DIR/agents" ]; then
    agent_count=$(ls "$PROFILE_DIR/agents"/*.md 2>/dev/null | wc -l | tr -d ' ')
    echo -e "  ${GREEN}→${NC} agents/ ($agent_count personas)"
    CORE_COUNT=$((CORE_COUNT + agent_count))
fi

if [ -f "$PROFILE_DIR/.workflow/config.json" ]; then
    echo -e "  ${GREEN}→${NC} config.json ${DIM}(will merge)${NC}"
    CORE_COUNT=$((CORE_COUNT + 1))
fi

# RULES & DECISIONS
if [ "$SKIP_RULES" != true ]; then
    HAS_RULES=false

    if [ -f "$PROFILE_DIR/.workflow/state/decisions.md" ]; then
        HAS_RULES=true
    fi

    if [ -d "$PROFILE_DIR/.claude/rules" ]; then
        rule_count=$(ls "$PROFILE_DIR/.claude/rules"/*.md 2>/dev/null | wc -l | tr -d ' ')
        if [ "$rule_count" -gt 0 ]; then
            HAS_RULES=true
        fi
    fi

    if [ "$HAS_RULES" = true ]; then
        echo ""
        echo -e "${DIM}Rules & Decisions:${NC}"

        if [ -f "$PROFILE_DIR/.workflow/state/decisions.md" ]; then
            echo -e "  ${YELLOW}→${NC} decisions.md ${DIM}(will append)${NC}"
            RULES_COUNT=$((RULES_COUNT + 1))
        fi

        if [ -d "$PROFILE_DIR/.claude/rules" ]; then
            rule_count=$(ls "$PROFILE_DIR/.claude/rules"/*.md 2>/dev/null | wc -l | tr -d ' ')
            if [ "$rule_count" -gt 0 ]; then
                echo -e "  ${GREEN}→${NC} .claude/rules/ ($rule_count rules)"
                RULES_COUNT=$((RULES_COUNT + rule_count))
            fi
        fi
    fi
fi

# LEARNINGS
if [ "$SKIP_LEARNINGS" != true ]; then
    HAS_LEARNINGS=false

    if [ -f "$PROFILE_DIR/.workflow/state/feedback-patterns.md" ]; then
        HAS_LEARNINGS=true
    fi

    if [ -d "$PROFILE_DIR/.claude/skills" ]; then
        skill_count=$(find "$PROFILE_DIR/.claude/skills" -name "patterns.md" -o -name "learnings.md" 2>/dev/null | wc -l | tr -d ' ')
        if [ "$skill_count" -gt 0 ]; then
            HAS_LEARNINGS=true
        fi
    fi

    if [ "$HAS_LEARNINGS" = true ]; then
        echo ""
        echo -e "${DIM}Learnings:${NC}"

        if [ -f "$PROFILE_DIR/.workflow/state/feedback-patterns.md" ]; then
            echo -e "  ${YELLOW}→${NC} feedback-patterns.md ${DIM}(will append)${NC}"
            LEARNINGS_COUNT=$((LEARNINGS_COUNT + 1))
        fi

        if [ -d "$PROFILE_DIR/.claude/skills" ]; then
            skill_dirs=$(find "$PROFILE_DIR/.claude/skills" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
            if [ "$skill_dirs" -gt 0 ]; then
                echo -e "  ${GREEN}→${NC} skill learnings ($skill_dirs skills)"
                LEARNINGS_COUNT=$((LEARNINGS_COUNT + skill_dirs))
            fi
        fi
    fi
fi

# TEMPLATES
if [ "$SKIP_TEMPLATES" != true ] && [ -d "$PROFILE_DIR/templates" ]; then
    template_count=$(ls "$PROFILE_DIR/templates"/*.md 2>/dev/null | wc -l | tr -d ' ')
    if [ "$template_count" -gt 0 ]; then
        echo ""
        echo -e "${DIM}Templates:${NC}"
        for template in "$PROFILE_DIR/templates"/*.md; do
            if [ -f "$template" ]; then
                echo -e "  ${GREEN}→${NC} $(basename "$template")"
                TEMPLATES_COUNT=$((TEMPLATES_COUNT + 1))
            fi
        done
    fi
fi

# APP MAP (optional)
if [ -f "$PROFILE_DIR/.workflow/state/app-map.md" ]; then
    echo ""
    echo -e "${DIM}Component Registry (optional):${NC}"
    echo -e "  ${YELLOW}→${NC} app-map.md ${DIM}(will ask)${NC}"
fi

echo ""

# Dry run stops here
if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}Dry run - no changes made${NC}"
    rm -rf "$TEMP_DIR"
    exit 0
fi

# Confirm unless forced
if [ "$FORCE" != true ]; then
    echo -e "${CYAN}Summary:${NC} $CORE_COUNT core, $RULES_COUNT rules, $LEARNINGS_COUNT learnings, $TEMPLATES_COUNT templates"
    echo ""
    read -p "Import these files? (y/N) " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        echo "Cancelled"
        rm -rf "$TEMP_DIR"
        exit 0
    fi
fi

# Create backup if requested
if [ "$BACKUP" = true ]; then
    BACKUP_DIR="wogi-backup-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$BACKUP_DIR"

    [ -f "CLAUDE.md" ] && cp "CLAUDE.md" "$BACKUP_DIR/"
    [ -d "agents" ] && cp -r "agents" "$BACKUP_DIR/"
    [ -d ".claude/rules" ] && cp -r ".claude/rules" "$BACKUP_DIR/"
    [ -f "$WORKFLOW_DIR/config.json" ] && cp "$WORKFLOW_DIR/config.json" "$BACKUP_DIR/"
    [ -f "$WORKFLOW_DIR/state/decisions.md" ] && cp "$WORKFLOW_DIR/state/decisions.md" "$BACKUP_DIR/"
    [ -f "$WORKFLOW_DIR/state/feedback-patterns.md" ] && cp "$WORKFLOW_DIR/state/feedback-patterns.md" "$BACKUP_DIR/"

    echo -e "${GREEN}✓${NC} Backup created: $BACKUP_DIR"
    echo ""
fi

# ==========================================
# Import files
# ==========================================
echo -e "${CYAN}Importing...${NC}"
echo ""

# CLAUDE.md
if [ -f "$PROFILE_DIR/CLAUDE.md" ]; then
    cp "$PROFILE_DIR/CLAUDE.md" ./
    echo -e "  ${GREEN}✓${NC} CLAUDE.md"
fi

# agents/
if [ -d "$PROFILE_DIR/agents" ]; then
    mkdir -p agents
    cp "$PROFILE_DIR/agents"/*.md agents/
    echo -e "  ${GREEN}✓${NC} agents/"
fi

# config.json (smart merge)
if [ -f "$PROFILE_DIR/.workflow/config.json" ]; then
    mkdir -p "$WORKFLOW_DIR"
    if [ -f "$WORKFLOW_DIR/config.json" ]; then
        # Use jq to merge if available, otherwise replace
        if command -v jq &> /dev/null; then
            # Merge: profile values override, but keep local additions
            jq -s '.[0] * .[1]' "$WORKFLOW_DIR/config.json" "$PROFILE_DIR/.workflow/config.json" > "$WORKFLOW_DIR/config.json.tmp"
            mv "$WORKFLOW_DIR/config.json.tmp" "$WORKFLOW_DIR/config.json"
            echo -e "  ${GREEN}✓${NC} config.json ${DIM}(merged)${NC}"
        else
            cp "$PROFILE_DIR/.workflow/config.json" "$WORKFLOW_DIR/"
            echo -e "  ${GREEN}✓${NC} config.json ${DIM}(replaced)${NC}"
        fi
    else
        cp "$PROFILE_DIR/.workflow/config.json" "$WORKFLOW_DIR/"
        echo -e "  ${GREEN}✓${NC} config.json"
    fi
fi

# decisions.md (append if exists)
if [ "$SKIP_RULES" != true ] && [ -f "$PROFILE_DIR/.workflow/state/decisions.md" ]; then
    mkdir -p "$WORKFLOW_DIR/state"
    if [ -f "$WORKFLOW_DIR/state/decisions.md" ]; then
        echo "" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "---" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "## Imported from profile" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "Source: $(basename "$PROFILE_FILE")" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "Imported: $(date +%Y-%m-%d)" >> "$WORKFLOW_DIR/state/decisions.md"
        echo "" >> "$WORKFLOW_DIR/state/decisions.md"
        # Skip the header from the imported file
        tail -n +3 "$PROFILE_DIR/.workflow/state/decisions.md" >> "$WORKFLOW_DIR/state/decisions.md"
        echo -e "  ${GREEN}✓${NC} decisions.md ${DIM}(appended)${NC}"
    else
        cp "$PROFILE_DIR/.workflow/state/decisions.md" "$WORKFLOW_DIR/state/"
        echo -e "  ${GREEN}✓${NC} decisions.md"
    fi
fi

# .claude/rules/
if [ "$SKIP_RULES" != true ] && [ -d "$PROFILE_DIR/.claude/rules" ]; then
    mkdir -p ".claude/rules"
    for rule_file in "$PROFILE_DIR/.claude/rules"/*.md; do
        if [ -f "$rule_file" ]; then
            cp "$rule_file" ".claude/rules/"
        fi
    done
    echo -e "  ${GREEN}✓${NC} .claude/rules/"
fi

# feedback-patterns.md (append if exists)
if [ "$SKIP_LEARNINGS" != true ] && [ -f "$PROFILE_DIR/.workflow/state/feedback-patterns.md" ]; then
    mkdir -p "$WORKFLOW_DIR/state"
    if [ -f "$WORKFLOW_DIR/state/feedback-patterns.md" ]; then
        echo "" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        echo "---" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        echo "" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        echo "## Imported patterns" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        echo "Source: $(basename "$PROFILE_FILE")" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        echo "" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        tail -n +3 "$PROFILE_DIR/.workflow/state/feedback-patterns.md" >> "$WORKFLOW_DIR/state/feedback-patterns.md"
        echo -e "  ${GREEN}✓${NC} feedback-patterns.md ${DIM}(appended)${NC}"
    else
        cp "$PROFILE_DIR/.workflow/state/feedback-patterns.md" "$WORKFLOW_DIR/state/"
        echo -e "  ${GREEN}✓${NC} feedback-patterns.md"
    fi
fi

# Skill learnings
if [ "$SKIP_LEARNINGS" != true ] && [ -d "$PROFILE_DIR/.claude/skills" ]; then
    for skill_dir in "$PROFILE_DIR/.claude/skills"/*/; do
        if [ -d "$skill_dir/knowledge" ]; then
            skill_name=$(basename "$skill_dir")
            mkdir -p ".claude/skills/$skill_name/knowledge"

            # Copy patterns.md and learnings.md
            for file in patterns.md learnings.md; do
                if [ -f "$skill_dir/knowledge/$file" ]; then
                    if [ -f ".claude/skills/$skill_name/knowledge/$file" ]; then
                        # Append to existing
                        echo "" >> ".claude/skills/$skill_name/knowledge/$file"
                        echo "---" >> ".claude/skills/$skill_name/knowledge/$file"
                        echo "## Imported from profile" >> ".claude/skills/$skill_name/knowledge/$file"
                        tail -n +3 "$skill_dir/knowledge/$file" >> ".claude/skills/$skill_name/knowledge/$file"
                    else
                        cp "$skill_dir/knowledge/$file" ".claude/skills/$skill_name/knowledge/"
                    fi
                fi
            done
        fi
    done
    echo -e "  ${GREEN}✓${NC} skill learnings"
fi

# Templates (copy to .workflow/templates/)
if [ "$SKIP_TEMPLATES" != true ] && [ -d "$PROFILE_DIR/templates" ]; then
    mkdir -p "$WORKFLOW_DIR/templates"
    for template in "$PROFILE_DIR/templates"/*.md; do
        if [ -f "$template" ]; then
            template_name=$(basename "$template")
            # Only copy if doesn't exist (templates are starting points)
            if [ ! -f "$WORKFLOW_DIR/templates/$template_name" ]; then
                cp "$template" "$WORKFLOW_DIR/templates/"
            fi
        fi
    done
    echo -e "  ${GREEN}✓${NC} templates"
fi

# App-map (ask before importing)
if [ -f "$PROFILE_DIR/.workflow/state/app-map.md" ]; then
    if [ "$FORCE" = true ]; then
        mkdir -p "$WORKFLOW_DIR/state"
        cp "$PROFILE_DIR/.workflow/state/app-map.md" "$WORKFLOW_DIR/state/"
        echo -e "  ${GREEN}✓${NC} app-map.md"
    else
        echo ""
        read -p "Import app-map.md? (This is usually project-specific) (y/N) " import_appmap
        if [ "$import_appmap" = "y" ] || [ "$import_appmap" = "Y" ]; then
            mkdir -p "$WORKFLOW_DIR/state"
            cp "$PROFILE_DIR/.workflow/state/app-map.md" "$WORKFLOW_DIR/state/"
            echo -e "  ${GREEN}✓${NC} app-map.md"
        else
            echo -e "  ${DIM}⊘${NC} app-map.md ${DIM}(skipped)${NC}"
        fi
    fi
fi

# Cleanup
rm -rf "$TEMP_DIR"

echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  ✓ Profile imported successfully!                        ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${DIM}Restart Claude CLI to apply changes.${NC}"

# Sync rules if decisions were imported
if [ "$SKIP_RULES" != true ] && [ -f "$WORKFLOW_DIR/state/decisions.md" ]; then
    if [ -f "./scripts/flow-rules-sync.js" ]; then
        echo ""
        echo -e "${DIM}Syncing rules from decisions.md...${NC}"
        node ./scripts/flow-rules-sync.js 2>/dev/null || true
    fi
fi

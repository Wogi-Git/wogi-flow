#!/bin/bash

# Wogi Flow - Health Check
# Verifies workflow files are in sync and properly configured

set -e

WORKFLOW_DIR=".workflow"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}Wogi Flow Health Check${NC}"
echo "========================"
echo ""

issues=0
warnings=0

# Check required files exist
echo -e "${CYAN}Checking required files...${NC}"

required_files=(
    "$WORKFLOW_DIR/config.json"
    "$WORKFLOW_DIR/state/ready.json"
    "$WORKFLOW_DIR/state/request-log.md"
    "$WORKFLOW_DIR/state/app-map.md"
    "$WORKFLOW_DIR/state/decisions.md"
    "$WORKFLOW_DIR/state/progress.md"
    "CLAUDE.md"
)

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo -e "  ${GREEN}✓${NC} $file"
    else
        echo -e "  ${RED}✗${NC} $file - MISSING"
        issues=$((issues + 1))
    fi
done

# Check required directories
echo ""
echo -e "${CYAN}Checking directories...${NC}"

required_dirs=(
    "$WORKFLOW_DIR/state/components"
    "$WORKFLOW_DIR/specs"
    "$WORKFLOW_DIR/changes"
    "$WORKFLOW_DIR/bugs"
    "$WORKFLOW_DIR/archive"
    "agents"
    "scripts"
)

for dir in "${required_dirs[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "  ${GREEN}✓${NC} $dir/"
    else
        echo -e "  ${RED}✗${NC} $dir/ - MISSING"
        issues=$((issues + 1))
    fi
done

# Check config.json is valid JSON
echo ""
echo -e "${CYAN}Validating config.json...${NC}"

if [ -f "$WORKFLOW_DIR/config.json" ]; then
    if python3 -c "import json; json.load(open('$WORKFLOW_DIR/config.json'))" 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} Valid JSON"
    else
        echo -e "  ${RED}✗${NC} Invalid JSON syntax"
        issues=$((issues + 1))
    fi
fi

# Check ready.json is valid JSON
echo ""
echo -e "${CYAN}Validating ready.json...${NC}"

if [ -f "$WORKFLOW_DIR/state/ready.json" ]; then
    if python3 -c "import json; json.load(open('$WORKFLOW_DIR/state/ready.json'))" 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} Valid JSON"
    else
        echo -e "  ${RED}✗${NC} Invalid JSON syntax"
        issues=$((issues + 1))
    fi
fi

# Check app-map vs actual components
echo ""
echo -e "${CYAN}Checking app-map sync...${NC}"

if [ -d "src/components" ]; then
    component_count=$(find src/components -name "*.tsx" -o -name "*.jsx" 2>/dev/null | wc -l)
    mapped_count=$(grep -c "^|" "$WORKFLOW_DIR/state/app-map.md" 2>/dev/null || echo 0)
    mapped_count=$((mapped_count - 3)) # Subtract header rows
    
    if [ $mapped_count -lt 0 ]; then mapped_count=0; fi
    
    echo -e "  Components in src/: $component_count"
    echo -e "  Components in app-map: $mapped_count"
    
    if [ $component_count -gt $((mapped_count + 5)) ]; then
        echo -e "  ${YELLOW}⚠${NC} App-map may be out of sync"
        echo -e "    Run: ./scripts/flow update-map scan src/components"
        warnings=$((warnings + 1))
    else
        echo -e "  ${GREEN}✓${NC} App-map appears in sync"
    fi
else
    echo -e "  ${YELLOW}⚠${NC} src/components/ not found (may be OK for new projects)"
fi

# Check git status
echo ""
echo -e "${CYAN}Checking git status...${NC}"

if [ -d ".git" ]; then
    uncommitted=$(git status --porcelain 2>/dev/null | wc -l)
    if [ $uncommitted -eq 0 ]; then
        echo -e "  ${GREEN}✓${NC} Working directory clean"
    else
        echo -e "  ${YELLOW}⚠${NC} $uncommitted uncommitted changes"
        warnings=$((warnings + 1))
    fi
else
    echo -e "  ${YELLOW}⚠${NC} Not a git repository"
    warnings=$((warnings + 1))
fi

# Check request-log recent activity
echo ""
echo -e "${CYAN}Checking request-log...${NC}"

if [ -f "$WORKFLOW_DIR/state/request-log.md" ]; then
    entry_count=$(grep -c "^### R-" "$WORKFLOW_DIR/state/request-log.md" 2>/dev/null || echo 0)
    echo -e "  Total entries: $entry_count"
    
    if [ $entry_count -gt 0 ]; then
        last_entry=$(grep "^### R-" "$WORKFLOW_DIR/state/request-log.md" | tail -1)
        echo -e "  Last entry: $last_entry"
    fi
fi

# Check agents exist
echo ""
echo -e "${CYAN}Checking agents...${NC}"

core_agents=("orchestrator" "developer" "reviewer" "tester")
optional_agents=("accessibility" "security" "performance" "docs" "design-system" "onboarding")

for agent in "${core_agents[@]}"; do
    if [ -f "agents/$agent.md" ]; then
        echo -e "  ${GREEN}✓${NC} $agent.md"
    else
        echo -e "  ${RED}✗${NC} $agent.md - MISSING (core agent)"
        issues=$((issues + 1))
    fi
done

for agent in "${optional_agents[@]}"; do
    if [ -f "agents/$agent.md" ]; then
        echo -e "  ${GREEN}✓${NC} $agent.md (optional)"
    fi
done

# Summary
echo ""
echo "========================"

if [ $issues -eq 0 ] && [ $warnings -eq 0 ]; then
    echo -e "${GREEN}✓ Workflow is healthy!${NC}"
elif [ $issues -eq 0 ]; then
    echo -e "${YELLOW}⚠ $warnings warning(s), but no critical issues${NC}"
else
    echo -e "${RED}✗ $issues issue(s), $warnings warning(s)${NC}"
    echo ""
    echo "Run './scripts/flow init' to fix missing files"
fi

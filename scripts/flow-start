#!/bin/bash

# Wogi Flow - Start Task

set -e

WORKFLOW_DIR=".workflow"
READY_JSON="$WORKFLOW_DIR/state/ready.json"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo "Usage: flow start <task-id>"
    exit 1
fi

TASK_ID="$1"

if [ ! -f "$READY_JSON" ]; then
    echo -e "${RED}Error: No ready.json found${NC}"
    exit 1
fi

python3 << EOF
import json

task_id = "$TASK_ID"

with open('$READY_JSON') as f:
    data = json.load(f)

# Find task in ready
ready = data.get('ready', [])
found = None
found_idx = None

for i, task in enumerate(ready):
    if isinstance(task, dict):
        if task.get('id') == task_id:
            found = task
            found_idx = i
            break
    elif task == task_id:
        found = {'id': task_id}
        found_idx = i
        break

if found is None:
    print(f'\033[0;31mTask {task_id} not found in ready queue\033[0m')
    exit(1)

# Move to in progress
ready.pop(found_idx)
data['ready'] = ready

in_progress = data.get('inProgress', [])
in_progress.append(found)
data['inProgress'] = in_progress

# Update timestamp
from datetime import datetime
data['lastUpdated'] = datetime.now().isoformat()

with open('$READY_JSON', 'w') as f:
    json.dump(data, f, indent=2)

print(f'\033[0;32mâœ“ Started: {task_id}\033[0m')
if isinstance(found, dict) and found.get('title'):
    print(f'  {found["title"]}')
EOF

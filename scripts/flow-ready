#!/bin/bash

# Wogi Flow - Show Ready Tasks

set -e

WORKFLOW_DIR=".workflow"
READY_JSON="$WORKFLOW_DIR/state/ready.json"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

if [ ! -f "$READY_JSON" ]; then
    echo -e "${RED}Error: No ready.json found${NC}"
    echo "Run: ./scripts/flow init"
    exit 1
fi

echo -e "${CYAN}Task Queue${NC}"
echo "==========="
echo ""

python3 << EOF
import json

with open('$READY_JSON') as f:
    data = json.load(f)

# Ready tasks
ready = data.get('ready', [])
if ready:
    print('\033[0;32mâœ“ READY\033[0m')
    for task in ready:
        if isinstance(task, dict):
            priority = task.get('priority', '-')
            print(f"  [{priority}] {task.get('id', '?')}: {task.get('title', 'No title')}")
        else:
            print(f"  â€¢ {task}")
    print()

# In progress
in_progress = data.get('inProgress', [])
if in_progress:
    print('\033[1;33mâ³ IN PROGRESS\033[0m')
    for task in in_progress:
        if isinstance(task, dict):
            print(f"  â€¢ {task.get('id', '?')}: {task.get('title', 'No title')}")
        else:
            print(f"  â€¢ {task}")
    print()

# Blocked
blocked = data.get('blocked', [])
if blocked:
    print('\033[0;31mðŸš« BLOCKED\033[0m')
    for task in blocked:
        if isinstance(task, dict):
            reason = task.get('reason', 'Unknown')
            print(f"  â€¢ {task.get('id', '?')}: {reason}")
        else:
            print(f"  â€¢ {task}")
    print()

# Recently completed
completed = data.get('recentlyCompleted', [])
if completed:
    print('\033[0;36mâœ… RECENTLY COMPLETED\033[0m')
    for task in completed[:5]:  # Last 5
        if isinstance(task, dict):
            print(f"  â€¢ {task.get('id', '?')}: {task.get('title', 'No title')}")
        else:
            print(f"  â€¢ {task}")
    print()

# Summary
total = len(ready) + len(in_progress) + len(blocked)
print(f"Total active: {total} ({len(ready)} ready, {len(in_progress)} in progress, {len(blocked)} blocked)")
EOF

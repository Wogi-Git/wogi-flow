# v1.8 Critical Review & AWS Architecture Plan

## Executive Summary

After reviewing all v1.8 features with scrutiny, there are significant issues that prevent this from being a viable product:

1. **No actual backend** - Team features are UI-only with no working API
2. **Duplicate code** - PRD chunking, storage logic exists in 3 places
3. **Poor integration** - Modules don't talk to each other
4. **No offline support** - Operations fail when network is unavailable
5. **Security gaps** - Tokens stored in plain JSON

This document outlines fixes needed and an AWS architecture.

---

## Part 1: Critical Review of v1.8 Features

### 1. MCP Memory Server

| Aspect | Status | Issue |
|--------|--------|-------|
| Local storage | ✅ Works | SQLite with sql.js is solid |
| Embeddings | ✅ Works | MiniLM model via transformers.js |
| MCP protocol | ✅ Works | Correctly implements tools |
| Team sync | ❌ Broken | Just stores locally, no actual API calls |
| Performance | ⚠️ Slow | 5-10s cold start for embeddings |
| Scalability | ⚠️ Poor | Linear scan for similarity search |

**Verdict**: Good foundation, but team features are non-functional.

### 2. Knowledge Router

| Aspect | Status | Issue |
|--------|--------|-------|
| Route detection | ⚠️ Basic | Keyword matching, arbitrary confidence |
| Integration | ✅ Works | Properly calls skill-learn and model-adapter |
| Storage | ❌ Duplicate | Duplicates MCP server storage logic |
| Learning | ❌ Missing | No feedback loop to improve routing |

**Verdict**: Basic functionality works but not intelligent.

### 3. Team Module (flow-team.js)

| Aspect | Status | Issue |
|--------|--------|-------|
| State management | ✅ Works | Clean local state |
| API client | ❌ No backend | All requests fail with network error |
| Offline support | ❌ Missing | No queue for offline operations |
| Security | ⚠️ Weak | Tokens in plain JSON |
| Error handling | ✅ Works | Graceful degradation |

**Verdict**: Client code is ready but useless without backend.

### 4. PRD Manager

| Aspect | Status | Issue |
|--------|--------|-------|
| Chunking | ✅ Works | Reasonable section-based chunking |
| Storage | ❌ Duplicate | Separate from MCP server |
| Retrieval | ⚠️ Weak | Keyword similarity, not embeddings |
| Integration | ❌ Missing | Doesn't use MCP memory server |

**Verdict**: Duplicates MCP server functionality poorly.

---

## Part 2: Consolidation Plan

### Remove Duplication

```
CURRENT STATE:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  MCP Memory     │  │  PRD Manager    │  │ Knowledge Router│
│  - embeddings   │  │  - chunking     │  │  - routing      │
│  - storage      │  │  - storage      │  │  - storage      │
│  - PRD chunks   │  │  - retrieval    │  │  - team props   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
        │                    │                    │
        └────────────────────┴────────────────────┘
                 3 SEPARATE DATABASES!

TARGET STATE:
┌─────────────────────────────────────────────────────────┐
│                    MCP Memory Server                     │
│  - ALL local storage (facts, proposals, PRD chunks)     │
│  - ALL embeddings                                       │
│  - ALL similarity search                                │
└───────────────────────────┬─────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼───────┐  ┌────────▼────────┐  ┌──────▼───────┐
│  PRD Manager  │  │Knowledge Router │  │  Team Module │
│  (thin layer) │  │  (thin layer)   │  │ (sync only)  │
│  - load file  │  │  - detect route │  │ - API calls  │
│  - call MCP   │  │  - call MCP     │  │ - auth       │
└───────────────┘  └─────────────────┘  └──────────────┘
```

### Specific Fixes

1. **PRD Manager** → Remove storage, just call MCP server's `store_prd` and `get_prd_context`
2. **Knowledge Router** → Remove storage, call MCP server's `remember_fact`
3. **Team Module** → Only handles API calls and sync, uses MCP server for storage

---

## Part 3: AWS Architecture

### Why AWS over Supabase

| Factor | AWS | Supabase |
|--------|-----|----------|
| Vendor lock-in | Low (standard services) | High (proprietary features) |
| Cost at scale | Lower | Higher |
| Self-host option | Full control | Limited |
| Auth flexibility | Cognito + custom | Auth0-like |
| Geographic presence | 30+ regions | Limited |

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AWS Cloud                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐    │
│  │    CloudFront    │────▶│   API Gateway    │────▶│     Lambda       │    │
│  │      (CDN)       │     │    (REST API)    │     │   (Functions)    │    │
│  └──────────────────┘     └────────┬─────────┘     └────────┬─────────┘    │
│                                    │                        │               │
│                           ┌────────▼─────────┐              │               │
│                           │     Cognito      │              │               │
│                           │ (Authentication) │              │               │
│                           └──────────────────┘              │               │
│                                                             │               │
│          ┌──────────────────────────────────────────────────┘               │
│          │                                                                   │
│          ▼                                                                   │
│  ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐    │
│  │    DynamoDB      │     │       S3         │     │      SQS         │    │
│  │   (Team Data)    │     │  (Large Files)   │     │  (Sync Queue)    │    │
│  │                  │     │                  │     │                  │    │
│  │  - teams         │     │  - PRD exports   │     │  - sync jobs     │    │
│  │  - users         │     │  - team configs  │     │  - proposals     │    │
│  │  - knowledge     │     │  - backups       │     │                  │    │
│  │  - proposals     │     │                  │     │                  │    │
│  └──────────────────┘     └──────────────────┘     └──────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### DynamoDB Schema

```
# Teams Table
PK: TEAM#{teamId}
SK: METADATA
Attributes: name, slug, createdAt, ownerId, subscription

# Team Members
PK: TEAM#{teamId}
SK: MEMBER#{userId}
Attributes: role, joinedAt, email

# Team Setups
PK: TEAM#{teamId}
SK: SETUP#{setupId}
Attributes: name, description, config, isDefault

# Knowledge Base
PK: TEAM#{teamId}
SK: KNOWLEDGE#{knowledgeId}
Attributes: fact, category, embedding, approvedAt
GSI1: category-createdAt-index

# Proposals
PK: TEAM#{teamId}
SK: PROPOSAL#{proposalId}
Attributes: rule, category, rationale, status, votes
GSI2: status-createdAt-index

# User Index
PK: USER#{userId}
SK: TEAM#{teamId}
Attributes: role (enables "get my teams" query)

# Invite Codes
PK: INVITE#{code}
SK: METADATA
Attributes: teamId, createdBy, expiresAt
TTL: expiresAt
```

### API Endpoints

```
POST   /auth/login              # Exchange invite code for token
POST   /auth/refresh            # Refresh JWT token
DELETE /auth/logout             # Invalidate token

GET    /teams                   # List user's teams
POST   /teams                   # Create team (paid feature)
GET    /teams/{id}              # Get team details
GET    /teams/{id}/setups       # List available setups
POST   /teams/{id}/setups/{s}/apply  # Apply setup to local config

GET    /teams/{id}/knowledge    # Get team knowledge (with since param)
POST   /teams/{id}/knowledge    # Add approved knowledge

GET    /teams/{id}/proposals    # List proposals
POST   /teams/{id}/proposals    # Create proposal
POST   /teams/{id}/proposals/{p}/vote  # Vote on proposal

POST   /teams/{id}/sync         # Full sync operation
GET    /teams/{id}/sync/status  # Sync status

POST   /teams/{id}/invites      # Generate invite code (admin)
```

### Cognito Setup

```
User Pool:
- Email/password authentication
- OAuth (GitHub, Google) for convenience
- Custom attribute: subscription_tier (free, team, enterprise)

Identity Pool:
- Federated identities
- IAM roles based on subscription tier
```

---

## Part 4: Implementation Plan

### Phase 1: Consolidate Local Storage (2-3 hours)
1. Remove duplicate storage from PRD Manager
2. Remove duplicate storage from Knowledge Router
3. Both should call MCP server tools instead
4. Test locally

### Phase 2: AWS Infrastructure (4-6 hours)
1. Set up Cognito user pool
2. Create DynamoDB tables
3. Create S3 bucket for large files
4. Set up API Gateway
5. Create Lambda functions for each endpoint
6. Deploy with CloudFormation/SAM

### Phase 3: Client Integration (2-3 hours)
1. Update flow-team.js to use AWS endpoints
2. Add proper JWT handling (refresh, secure storage)
3. Implement offline queue with retry
4. Add sync conflict resolution

### Phase 4: Testing & Polish (2-3 hours)
1. End-to-end testing
2. Error handling improvements
3. CLI output improvements
4. Documentation

---

## Part 5: Cost Estimate

### AWS Costs (per month, estimates)

| Service | Free Tier | Beyond Free |
|---------|-----------|-------------|
| Cognito | 50k MAU | $0.0055/MAU |
| API Gateway | 1M requests | $3.50/million |
| Lambda | 1M requests | $0.20/million |
| DynamoDB | 25GB, 25 WCU/RCU | Pay per use |
| S3 | 5GB | $0.023/GB |
| CloudFront | 1TB | $0.085/GB |

**Estimated cost for 1000 users**: ~$15-30/month

### Revenue Model

| Tier | Price | Features |
|------|-------|----------|
| Free | $0 | Local-only, no sync |
| Team | $10/user/mo | Team sync, proposals, shared knowledge |
| Enterprise | Custom | Self-hosted option, SSO, priority support |

---

## Part 6: Immediate Action Items

1. [ ] Consolidate PRD Manager to use MCP server
2. [ ] Consolidate Knowledge Router to use MCP server
3. [ ] Create AWS SAM/CloudFormation template
4. [ ] Implement Lambda functions
5. [ ] Update client to use real API
6. [ ] Add offline queue and sync
7. [ ] Write deployment documentation
8. [ ] Set up CI/CD for backend

---

## Files to Modify

| File | Change |
|------|--------|
| `scripts/flow-prd-manager.js` | Remove storage, call MCP server |
| `scripts/flow-knowledge-router.js` | Remove team storage, call MCP server |
| `scripts/flow-team.js` | Update API endpoints, add JWT refresh |
| `mcp-memory-server/index.js` | Add team sync integration |
| `NEW: aws/template.yaml` | CloudFormation/SAM template |
| `NEW: aws/lambda/` | Lambda function handlers |
